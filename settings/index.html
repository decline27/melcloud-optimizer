<!DOCTYPE html>
<html>
  <head>
    <script
      type="text/javascript"
      src="/homey.js"
      data-origin="settings"
    ></script>
    <style>
      .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .result-message {
        margin-top: 10px;
        font-style: italic;
      }
      .homey-button-warning {
        background-color: #f5a623;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
      }
      .homey-button-warning:hover {
        background-color: #e09612;
      }
    </style>
  </head>
  <body>
    <header class="homey-header">
      <h1 class="homey-title">MELCloud Optimizer Settings</h1>
      <p class="homey-subtitle">Configure your credentials and temperature settings</p>
    </header>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">MELCloud Credentials</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="melcloud_user">Email</label>
        <input class="homey-form-input" id="melcloud_user" type="text" value="" />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="melcloud_pass">Password</label>
        <input class="homey-form-input" id="melcloud_pass" type="password" value="" />
      </div>

      <div class="homey-form-group">
        <button id="refresh_devices" class="homey-button-primary">Refresh Device List</button>
        <span id="device_refresh_status"></span>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label" for="building_id">Building</label>
        <select class="homey-form-input" id="building_id">
          <option value="">Select a building</option>
        </select>
        <p class="homey-form-helper">Select your building from the dropdown or enter ID manually below</p>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label" for="device_id">Device</label>
        <select class="homey-form-input" id="device_id">
          <option value="">Select a device</option>
        </select>
        <p class="homey-form-helper">Select your device from the dropdown or enter ID manually below</p>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-checkbox">
          <input type="checkbox" id="show_manual_entry" />
          <span>Show manual ID entry fields</span>
        </label>
        <p class="homey-form-helper">Note: This option only affects this page and is not saved.</p>
      </div>

      <div id="manual_id_entry" style="display: none;">
        <div class="homey-form-group">
          <label class="homey-form-label" for="manual_device_id">Manual Device ID</label>
          <input class="homey-form-input" id="manual_device_id" type="text" value="" />
          <p class="homey-form-helper">The ID of your heat pump device in MELCloud (not stored; used only when saving)</p>
        </div>
        <div class="homey-form-group">
          <label class="homey-form-label" for="manual_building_id">Manual Building ID</label>
          <input class="homey-form-input" id="manual_building_id" type="text" value="" />
          <p class="homey-form-helper">The ID of the building (not stored; used only when saving)</p>
        </div>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Tibber API</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="tibber_token">API Token</label>
        <input class="homey-form-input" id="tibber_token" type="password" value="" />
        <p class="homey-form-helper">Get your token from <a href="https://developer.tibber.com/" target="_blank">https://developer.tibber.com/</a></p>
      </div>
    </fieldset>



    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Heating Temperature Settings</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="min_temp">Minimum Temperature (°C)</label>
        <input class="homey-form-input" id="min_temp" type="number" min="16" max="22" step="0.5" value="18" />
        <p class="homey-form-helper">The minimum temperature that will be set during optimization. Suggested default: 19°C - provides good balance between comfort and energy savings during price peaks.</p>
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="max_temp">Maximum Temperature (°C)</label>
        <input class="homey-form-input" id="max_temp" type="number" min="20" max="26" step="0.5" value="24" />
        <p class="homey-form-helper">The maximum temperature that will be set during optimization. Suggested default: 22°C - comfortable temperature during low-price periods without excessive energy use.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset" id="zone2_fieldset">
      <legend class="homey-form-legend">Zone 2 Temperature Settings</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="enable_zone2">Enable Zone 2 Control</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="enable_zone2" />
          <span>Enable optimization of Zone 2 temperature</span>
        </label>
        <p class="homey-form-helper">Enable separate temperature control for Zone 2 (if your device supports it)</p>
      </div>

      <div id="zone2_settings" style="display: none;">
        <div class="homey-form-group">
          <label class="homey-form-label" for="min_temp_zone2">Minimum Temperature Zone 2 (°C)</label>
          <input class="homey-form-input" id="min_temp_zone2" type="number" min="16" max="22" step="0.5" value="18" />
        </div>
        <div class="homey-form-group">
          <label class="homey-form-label" for="max_temp_zone2">Maximum Temperature Zone 2 (°C)</label>
          <input class="homey-form-input" id="max_temp_zone2" type="number" min="20" max="26" step="0.5" value="24" />
        </div>
        <div class="homey-form-group">
          <label class="homey-form-label" for="temp_step_zone2">Maximum Temperature Step Zone 2 (°C)</label>
          <input class="homey-form-input" id="temp_step_zone2" type="number" min="0.1" max="2.0" step="0.1" value="0.5" />
          <p class="homey-form-helper">Controls how much the Zone 2 temperature can change in one step.</p>
        </div>
      </div>
    </fieldset>

    <!-- Optimization Engine Settings -->
    <fieldset class="homey-form-fieldset" id="engine_fieldset">
      <legend class="homey-form-legend">Optimization Engine</legend>

      <div class="homey-form-group">
        <div style="background:#f7fbff;border:1px solid #dbe9ff;border-radius:6px;padding:10px;">
          <div style="font-weight:600;margin-bottom:6px;">How the Engine saves money</div>
          <div class="homey-form-helper" style="margin:0;">
            • Shifts heating to cheap hours (preheat), coasts in expensive hours.<br>
            • Keeps comfort within a band (occupied vs away).<br>
            • Reduces compressor cycling with a deadband and a minimum interval between changes.<br>
            • Applies weather context (for example, warm trend → smaller targets).
          </div>
        </div>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label" for="use_engine">Use Optimization Engine</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="use_engine" />
          <span>Comfort band control + price-aware preheating (recommended)</span>
        </label>
        <p class="homey-form-helper">Turn on the new engine for clearer control and savings. Turn off to use the classic optimizer. Suggested default: <b>Enabled</b>.</p>
        <p class="homey-form-helper">Impact: When enabled, decisions prioritize cost within your comfort band and respect the safety limits below.</p>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">Safety & Stability</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="deadband_c">Deadband (°C)</label>
            <input class="homey-form-input" id="deadband_c" type="number" min="0.1" max="2.0" step="0.1" value="0.3" />
            <p class="homey-form-helper">Small window around target to avoid jitter. Suggested default: <b>0.3°C</b>.</p>
            <p class="homey-form-helper">Impact: Larger deadband = fewer changes and less cycling (smoother), but slower fine‑tuning. Typical range 0.3–0.5°C.</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="min_setpoint_change_minutes">Min Setpoint Interval (min)</label>
            <input class="homey-form-input" id="min_setpoint_change_minutes" type="number" min="5" max="180" step="5" value="15" />
            <p class="homey-form-helper">Anti–short‑cycling lockout between changes. Suggested default: <b>15 minutes</b>.</p>
            <p class="homey-form-helper">Impact: Higher values reduce compressor starts and avoid fighting defrost cycles; too high can slow reactions to big price swings.</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="extreme_weather_min_temp">Extreme Cold Min (°C)</label>
            <input class="homey-form-input" id="extreme_weather_min_temp" type="number" min="16" max="23" step="0.5" value="20" />
            <p class="homey-form-helper">Minimum indoor target during deep cold. Suggested default: <b>20°C</b>.</p>
            <p class="homey-form-helper">Impact: Protects comfort/COP during cold snaps (prevents over‑setbacks). Increase if your home cools quickly.</p>
          </div>
        </div>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">Comfort Bands</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-checkbox">
              <input type="checkbox" id="occupied" />
              <span>Home is occupied</span>
            </label>
            <p class="homey-form-helper">Use occupied band; turn off for away band. Can be automated via Flows. Suggested default: <b>Enabled</b>.</p>
          </div>
        </div>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="comfort_lower_occupied">Occupied Lower (°C)</label>
            <input class="homey-form-input" id="comfort_lower_occupied" type="number" min="18" max="23" step="0.5" value="20" />
            <p class="homey-form-helper">Suggested default: <b>20.0°C</b>.</p>
            <p class="homey-form-helper">Impact: Lower values increase savings in expensive hours but feel cooler. Adjust to your comfort.</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="comfort_upper_occupied">Occupied Upper (°C)</label>
            <input class="homey-form-input" id="comfort_upper_occupied" type="number" min="19" max="24" step="0.5" value="21" />
            <p class="homey-form-helper">Suggested default: <b>21.0°C</b>.</p>
            <p class="homey-form-helper">Impact: Higher values allow more preheating in cheap hours (store heat), improving savings when a price spike is coming.</p>
          </div>
        </div>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="comfort_lower_away">Away Lower (°C)</label>
            <input class="homey-form-input" id="comfort_lower_away" type="number" min="17" max="22" step="0.5" value="19" />
            <p class="homey-form-helper">Suggested default: <b>19.0°C</b>.</p>
            <p class="homey-form-helper">Impact: Away band reduces cost when nobody’s home; keep within safe bounds for building/frost protection.</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="comfort_upper_away">Away Upper (°C)</label>
            <input class="homey-form-input" id="comfort_upper_away" type="number" min="18" max="23" step="0.5" value="20.5" />
            <p class="homey-form-helper">Suggested default: <b>20.5°C</b>.</p>
            <p class="homey-form-helper">Tip: Keep a 0.8–1.5°C spread between lower/upper for stable control.</p>
          </div>
        </div>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">Price‑Aware Preheating</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="preheat_enable" />
          <span>Enable preheating in cheap hours</span>
        </label>
        <p class="homey-form-helper">Suggested default: <b>Enabled</b>. Builds thermal buffer during low-price hours for use during peaks.</p>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="preheat_horizon_hours">Horizon (hours)</label>
            <input class="homey-form-input" id="preheat_horizon_hours" type="number" min="6" max="36" step="1" value="12" />
            <p class="homey-form-helper">How far ahead to evaluate prices. Suggested default: <b>12 hours</b>.</p>
            <p class="homey-form-helper">Impact: Longer horizon anticipates evening spikes earlier; too long can include noisy data. Try 12–24h.</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="preheat_cheap_percentile">Cheap percentile (0–1)</label>
            <input class="homey-form-input" id="preheat_cheap_percentile" type="number" min="0.05" max="0.5" step="0.05" value="0.25" />
            <p class="homey-form-helper">Treat hours at or below this percentile as cheap. Suggested default: <b>0.25</b> (25th percentile).</p>
            <p class="homey-form-helper">Impact: Lower values preheat only in the very cheapest hours (more selective). Higher values preheat more often.</p>
          </div>
        </div>
        <p class="homey-form-helper">Note: Some devices set to Flow/Curve modes may ignore room target changes. The Engine still optimizes within your comfort band, but the unit may apply targets via heating curve.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset" id="tank_fieldset">
      <legend class="homey-form-legend">Hot Water Tank Settings</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="enable_tank_control">Enable Hot Water Tank Control</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="enable_tank_control" />
          <span>Enable optimization of hot water tank temperature</span>
        </label>
        <p class="homey-form-helper">Enable optimization of hot water tank temperature based on electricity prices. Suggested default: Enabled - allows the system to store hot water as thermal energy when electricity is cheap.</p>
        <p class="homey-form-helper">Impact: Shifts DHW heating to cheap hours (with a small step and 0.5°C deadband for stability). Min/Max protect comfort and legionella schedules.</p>
        <p id="tank_capability_warning" class="homey-form-helper" style="display:none;color:#b00;">This device may not support tank water temperature control. If unsupported, these settings have no effect.</p>
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="min_tank_temp">Minimum Tank Temperature (°C)</label>
        <input class="homey-form-input" id="min_tank_temp" type="number" min="30" max="45" step="0.5" value="40" />
        <p class="homey-form-helper">Minimum allowed temperature for the hot water tank. Suggested default: 41°C - ensures sufficient hot water is always available while allowing for price optimization.</p>
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="max_tank_temp">Maximum Tank Temperature (°C)</label>
        <input class="homey-form-input" id="max_tank_temp" type="number" min="40" max="60" step="0.5" value="50" />
        <p class="homey-form-helper">Maximum allowed temperature for the hot water tank. Suggested default: 53°C - provides good thermal storage capacity without excessive energy use. Check your heat pump's maximum recommended tank temperature.</p>
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="tank_temp_step">Tank Temperature Step (°C)</label>
        <input class="homey-form-input" id="tank_temp_step" type="number" min="0.5" max="5.0" step="0.5" value="1.0" />
        <p class="homey-form-helper">Maximum change in tank temperature per optimization cycle. Suggested default: 2°C - allows for meaningful temperature adjustments without causing excessive cycling of the heat pump.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Hot Water Usage Patterns</legend>
      <div class="button-container">
        <button id="reset_patterns" class="homey-button" onclick="resetHotWaterPatterns()">Reset Usage Patterns</button>
        <button id="clear_keep_patterns" class="homey-button-warning" onclick="clearHotWaterData(true)">Clear Data (Keep Patterns)</button>
        <button id="clear_all_data" class="homey-button-danger" onclick="clearHotWaterData(false)">Clear All Data</button>
      </div>
      <p class="homey-form-helper">Reset Usage Patterns: Resets learned patterns to default values.<br>Clear Data (Keep Patterns): Removes detailed data points but keeps aggregated usage patterns.<br>Clear All Data: Removes all collected usage data and resets patterns.</p>
      <p id="hot_water_action_result" class="result-message"></p>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Notifications</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="notify_on_success">Notify On Success</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="notify_on_success" />
          <span>Send a notification when optimization/calibration succeeds</span>
        </label>
        <p class="homey-form-helper">When enabled, you will receive a Homey notification for successful hourly optimization and weekly calibration.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Localization</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="currency_code">Currency (ISO 4217)</label>
        <input class="homey-form-input" id="currency_code" type="text" placeholder="e.g., NOK, SEK, EUR" />
        <p class="homey-form-helper">Optional. Overrides automatic currency detection for timeline messages. Use a 3-letter code (e.g., NOK, SEK, EUR, DKK, USD).</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Weather Integration</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="use_weather_data">Use Weather Data</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="use_weather_data" checked />
          <span>Enable weather data integration (Met.no API)</span>
        </label>
        <p class="homey-form-helper">Uses weather data to improve temperature optimization based on outdoor conditions</p>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label" for="weather_location">Your Location</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="latitude">Latitude</label>
            <input class="homey-form-input" id="latitude" type="number" step="0.000001" placeholder="e.g., 51.5074" />
            <p class="homey-form-helper">Decimal degrees (e.g., 51.5074 for London)</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="longitude">Longitude</label>
            <input class="homey-form-input" id="longitude" type="number" step="0.000001" placeholder="e.g., -0.1278" />
            <p class="homey-form-helper">Decimal degrees (e.g., -0.1278 for London)</p>
          </div>
        </div>
        <button id="detect-location" class="homey-button-primary">Detect My Location</button>
        <p class="homey-form-helper">You can find your coordinates using <a href="https://www.latlong.net/" target="_blank">LatLong.net</a> or similar services</p>
        <p id="weather_location_warning" class="homey-form-helper" style="display:none;color:#b00;">Weather is enabled but coordinates are missing. Set latitude and longitude for accurate weather optimization.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Comfort Profiles</legend>
      <div class="homey-form-group">
        <label class="homey-form-label">Day Profile (Higher Comfort)</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="day_start_hour">Start Hour</label>
            <input class="homey-form-input" id="day_start_hour" type="number" min="0" max="23" step="1" value="6" />
            <p class="homey-form-helper">Hour when day profile begins (0-23)</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="day_end_hour">End Hour</label>
            <input class="homey-form-input" id="day_end_hour" type="number" min="0" max="23" step="1" value="22" />
            <p class="homey-form-helper">Hour when day profile ends (0-23)</p>
          </div>
        </div>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">Temperature Adjustments</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="night_temp_reduction">Night Reduction</label>
            <input class="homey-form-input" id="night_temp_reduction" type="number" min="0" max="5" step="0.5" value="2" />
            <p class="homey-form-helper">Temperature reduction during night (°C)</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="pre_heat_hours">Pre-heat Hours</label>
            <input class="homey-form-input" id="pre_heat_hours" type="number" min="0" max="3" step="0.5" value="1" />
            <p class="homey-form-helper">Hours before day start to begin pre-heating</p>
          </div>
        </div>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">Time Zone</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="time_zone_offset">UTC Offset</label>
            <select class="homey-form-input" id="time_zone_offset">
              <option value="-12">UTC-12:00</option>
              <option value="-11">UTC-11:00</option>
              <option value="-10">UTC-10:00</option>
              <option value="-9">UTC-09:00</option>
              <option value="-8">UTC-08:00</option>
              <option value="-7">UTC-07:00</option>
              <option value="-6">UTC-06:00</option>
              <option value="-5">UTC-05:00</option>
              <option value="-4">UTC-04:00</option>
              <option value="-3">UTC-03:00</option>
              <option value="-2">UTC-02:00</option>
              <option value="-1">UTC-01:00</option>
              <option value="0">UTC+00:00</option>
              <option value="1">UTC+01:00</option>
              <option value="2" selected>UTC+02:00</option>
              <option value="3">UTC+03:00</option>
              <option value="4">UTC+04:00</option>
              <option value="5">UTC+05:00</option>
              <option value="5.5">UTC+05:30</option>
              <option value="6">UTC+06:00</option>
              <option value="7">UTC+07:00</option>
              <option value="8">UTC+08:00</option>
              <option value="9">UTC+09:00</option>
              <option value="9.5">UTC+09:30</option>
              <option value="10">UTC+10:00</option>
              <option value="11">UTC+11:00</option>
              <option value="12">UTC+12:00</option>
              <option value="13">UTC+13:00</option>
            </select>
            <p class="homey-form-helper">Your local time zone offset from UTC</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="use_dst">Daylight Saving Time</label>
            <label class="homey-form-checkbox">
              <input type="checkbox" id="use_dst" checked />
              <span>Automatically adjust for DST</span>
            </label>
            <p class="homey-form-helper">Automatically adjust for daylight saving time changes</p>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">COP Optimization Settings</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="cop_weight">COP Weight Factor</label>
        <input class="homey-form-input" id="cop_weight" type="number" min="0.0" max="1.0" step="0.05" value="0.3" />
        <p class="homey-form-helper">Weight given to COP (Coefficient of Performance) in optimization. Suggested default: 0.3 - balanced approach that considers both price and efficiency. Higher values (0.5-0.8) prioritize energy efficiency over price savings, while lower values (0.1-0.2) prioritize price savings over efficiency. For maximum cost savings, use 0.0-0.1.</p>
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="auto_seasonal_mode">Seasonal Mode Settings</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="auto_seasonal_mode" checked />
          <span>Auto Seasonal Mode</span>
        </label>
        <p class="homey-form-helper">Automatically switch between summer and winter modes based on the month. Suggested default: Enabled - optimizes for hot water in summer (May-Sep) and heating in winter (Oct-Apr). This provides the best year-round performance without manual intervention.</p>
      </div>
      <div class="homey-form-group" id="summer_mode_container">
        <label class="homey-form-checkbox">
          <input type="checkbox" id="summer_mode" />
          <span>Summer Mode</span>
        </label>
        <p class="homey-form-helper">When enabled, prioritizes hot water heating over space heating. Only used when Auto Seasonal Mode is disabled. Suggested setting: Enabled during summer months when you primarily use the heat pump for hot water rather than heating.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Advanced Settings</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="log_level">Log Level</label>
        <select class="homey-form-input" id="log_level">
          <option value="0">Debug (Verbose)</option>
          <option value="1" selected>Info (Normal)</option>
          <option value="2">Warning (Minimal)</option>
          <option value="3">Error (Only Errors)</option>
        </select>
        <p class="homey-form-helper">Controls the amount of information logged. Debug provides the most detailed logs.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Manual Triggers</legend>
      <div class="homey-form-group">
        <p class="homey-form-helper">Use these buttons to manually trigger operations.</p>
        <div class="button-container">
          <button id="run_hourly" class="homey-button-primary" onclick="runHourlyOptimization()">Run Hourly Optimization</button>
          <button id="run_weekly" class="homey-button-primary" onclick="runWeeklyCalibration()">Run Weekly Calibration</button>
          <button id="manage_cron" class="homey-button" onclick="manageScheduledJobs()">Manage Scheduled Jobs</button>
          <button id="view_thermal_data" class="homey-button" onclick="viewThermalModelData()">View Thermal Model Data</button>
        </div>
        <p id="trigger_result" class="result-message"></p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Memory Management</legend>
      <div class="homey-form-group">
        <p class="homey-form-helper">Monitor and manage memory usage of the thermal model data collector.</p>
        <div class="button-container">
          <button id="check_memory" class="homey-button" onclick="checkMemoryUsage()">Check Memory Usage</button>
          <button id="run_cleanup" class="homey-button-primary" onclick="runDataCleanup()">Run Data Cleanup</button>
        </div>
        <div id="memory_stats" style="margin-top: 15px; display: none;">
          <h3>Memory Usage Statistics</h3>
          <div id="memory_stats_content" style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap;"></div>
        </div>
        <p id="memory_result" class="result-message"></p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Savings Summary</legend>
      <div class="homey-form-group">
        <p class="homey-form-helper">Get a quick view of your savings for today, last 7 days, and last 30 days.</p>
        <div class="button-container">
          <button id="view_savings_summary" class="homey-button" onclick="viewSavingsSummary()">View Savings Summary</button>
          <button id="copy_savings_summary" class="homey-button" onclick="copySavingsSummary()" disabled>Copy Summary</button>
        </div>
        <div id="savings_summary_panel" style="margin-top: 15px; display: none;">
          <h3>Savings</h3>
          <div id="savings_summary_content" style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap;"></div>
          <div style="margin-top:10px;">
            <canvas id="savings_chart_7" width="280" height="90" style="background:#fafafa;border:1px solid #eee;border-radius:4px;"></canvas>
            <div class="homey-form-helper">Last 7 days</div>
          </div>
          <div style="margin-top:10px;">
            <canvas id="savings_chart_30" width="420" height="100" style="background:#fafafa;border:1px solid #eee;border-radius:4px;"></canvas>
            <div class="homey-form-helper">Last 30 days</div>
          </div>
        </div>
        <p id="savings_summary_result" class="result-message"></p>
      </div>
    </fieldset>

    <button id="save" class="homey-button-primary-full">Save changes</button>

    <script type="text/javascript">
      // Global Homey object
      let HomeyInstance;

      // Function to run hourly optimization
      function runHourlyOptimization() {
        console.log('Hourly optimization button clicked');

        // Disable button and show loading state
        document.getElementById('run_hourly').disabled = true;
        document.getElementById('trigger_result').textContent = "Running hourly optimization...";

        // Call the API
        HomeyInstance.api('GET', '/runHourlyOptimizer', {}, function(err, result) {
          if (err) {
            console.error('Error calling /runHourlyOptimizer:', err);
            document.getElementById('run_hourly').disabled = false;
            document.getElementById('trigger_result').textContent = "Error: " + err.message;
            return HomeyInstance.alert(err.message);
          }

          console.log('/runHourlyOptimizer called successfully:', result);

          // Show success message
          document.getElementById('run_hourly').disabled = false;
          document.getElementById('trigger_result').textContent = "Hourly optimization completed successfully! Check the timeline for details.";
        });
      }

      // Function to run weekly calibration
      function runWeeklyCalibration() {
        console.log('Weekly calibration button clicked');

        // Disable button and show loading state
        document.getElementById('run_weekly').disabled = true;
        document.getElementById('trigger_result').textContent = "Running weekly calibration...";

        // Call the API
        HomeyInstance.api('GET', '/runWeeklyCalibration', {}, function(err, result) {
          if (err) {
            console.error('Error calling /runWeeklyCalibration:', err);
            document.getElementById('run_weekly').disabled = false;
            document.getElementById('trigger_result').textContent = "Error: " + err.message;
            return HomeyInstance.alert(err.message);
          }

          console.log('/runWeeklyCalibration called successfully:', result);

          // Show success message
          document.getElementById('run_weekly').disabled = false;
          document.getElementById('trigger_result').textContent = "Weekly calibration completed successfully! Check the timeline for details.";
        });
      }

      // Function to view savings summary
      function viewSavingsSummary() {
        console.log('View savings summary button clicked');

        const button = document.getElementById('view_savings_summary');
        const resultEl = document.getElementById('savings_summary_result');
        const panel = document.getElementById('savings_summary_panel');
        const content = document.getElementById('savings_summary_content');

        button.disabled = true;
        resultEl.textContent = 'Fetching savings summary...';

        HomeyInstance.api('GET', '/getSavingsSummary', {}, function(err, result) {
          if (err) {
            console.error('Error fetching savings summary:', err);
            button.disabled = false;
            // Fallback: if endpoint not found (older app manifest), compute on client
            if (String(err && err.message || '').toLowerCase().includes('not found')) {
              resultEl.textContent = 'Endpoint not found; computing summary locally...';
              computeLocalSavingsSummary().then((local) => {
                renderSavingsSummary(local, content, panel, resultEl, button);
              }).catch((e) => {
                resultEl.textContent = 'Error: ' + (e.message || 'Failed to compute local summary');
                HomeyInstance.alert('Not found: GET /getSavingsSummary. Please update/restart the app.');
              });
              return;
            }
            resultEl.textContent = 'Error: ' + err.message;
            return HomeyInstance.alert(err.message);
          }

          if (!result || !result.success) {
            button.disabled = false;
            const msg = result && result.error ? result.error : 'Unknown error retrieving savings summary';
            resultEl.textContent = 'Error: ' + msg;
            return HomeyInstance.alert(msg);
          }
          renderSavingsSummary(result, content, panel, resultEl, button);
        });
      }

      function copySavingsSummary() {
        const content = document.getElementById('savings_summary_content');
        const text = content ? content.textContent : '';
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => {
            HomeyInstance.alert('Savings summary copied to clipboard.');
          }).catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = text; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); HomeyInstance.alert('Savings summary copied to clipboard.'); } finally { document.body.removeChild(ta); }
          });
        } else {
          // Fallback
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); HomeyInstance.alert('Savings summary copied to clipboard.'); } finally { document.body.removeChild(ta); }
        }
      }

      // Helper: render result into UI
      function renderSavingsSummary(result, content, panel, resultEl, button) {
        const { summary, todayDate, currencyCode } = result;

        // Format numbers with optional currency
        let formatter;
        try {
          if (currencyCode && /^[A-Z]{3}$/.test(currencyCode)) {
            formatter = new Intl.NumberFormat(undefined, { style: 'currency', currency: currencyCode, minimumFractionDigits: 2, maximumFractionDigits: 2 });
          } else {
            formatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          }
        } catch (e) {
          formatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        const fmt = (n) => {
          try { return formatter.format(Number(n || 0)); } catch { return String(n || 0); }
        };

        const lines = [
          `Date: ${todayDate}`,
          `Today: ${fmt(summary.today)}`,
          `Yesterday: ${fmt(summary.yesterday)}`,
          `Week to date (Mon–today): ${fmt(summary.weekToDate)}`,
          `Last 7 days: ${fmt(summary.last7Days)}`,
          `Month to date: ${fmt(summary.monthToDate)}`,
          `Last 30 days: ${fmt(summary.last30Days)}`
        ];
        if (summary.allTime !== undefined) {
          lines.push(`All-time total: ${fmt(summary.allTime)}`);
        }

        content.textContent = lines.join('\n');
        panel.style.display = 'block';
        resultEl.textContent = 'Savings summary ready!';
        document.getElementById('copy_savings_summary').disabled = false;
        button.disabled = false;

        // Draw charts using returned or computed series
        try {
          const series = (result.series && Array.isArray(result.series.last30)) ? result.series.last30 : [];
          const last7 = series.slice(-7);
          drawBarChart('savings_chart_7', last7);
          drawBarChart('savings_chart_30', series);
        } catch (e) {
          console.warn('Failed to draw savings charts:', e);
        }
      }

      // Helper: compute summary entirely on the client from stored settings
      function computeLocalSavingsSummary() {
        return new Promise((resolve, reject) => {
          try {
            const load = (key) => new Promise((res) => Homey.get(key, (_e, v) => res(v)));
            
            // Currency helper functions (same as in API)
            const currencyDecimals = {
              'JPY': 0,
              'KWD': 3,
              // Default is 2 for most currencies
            };

            const getCurrencyDecimals = (currency) => {
              return currencyDecimals[currency?.toUpperCase()] ?? 2;
            };

            const majorToMinor = (amount, decimals) => {
              if (typeof amount !== 'number' || isNaN(amount)) return 0;
              return Math.round(amount * Math.pow(10, decimals));
            };

            const minorToMajor = (amount, decimals) => {
              if (typeof amount !== 'number' || isNaN(amount)) return 0;
              return amount / Math.pow(10, decimals);
            };

            // Migrate legacy entry to new format
            const migrateLegacyEntry = (entry, currency, decimals) => {
              if (entry.totalMinor !== undefined) {
                // Already migrated, but ensure currency and decimals are set
                if (!entry.currency && currency) entry.currency = currency;
                if (entry.decimals === undefined) entry.decimals = decimals;
                return entry;
              }
              
              if (entry.total !== undefined) {
                // Legacy entry, convert to new format
                const totalMinor = majorToMinor(entry.total, decimals);
                return {
                  date: entry.date,
                  totalMinor,
                  currency,
                  decimals
                };
              }
              
              // Unknown format, return as-is
              return entry;
            };

            // Load currency and currency_code separately, then choose the first truthy value
            Promise.all([
              load('savings_history'),
              load('time_zone_offset'),
              load('use_dst'),
              Promise.all([load('currency'), load('currency_code')]).then(([c1, c2]) => c1 || c2 || '')
            ]).then(([rawHistory, tz, dst, currency]) => {
              const decimals = getCurrencyDecimals(currency);
              
              // Migrate legacy entries and normalize the history
              const migratedHistory = Array.isArray(rawHistory) 
                ? rawHistory.filter(h => h && typeof h.date === 'string').map(h => migrateLegacyEntry(h, currency, decimals))
                : [];
              
              if (migratedHistory.length === 0) {
                return resolve({ success: true, summary: { today: 0, yesterday: 0, weekToDate: 0, last7Days: 0, monthToDate: 0, last30Days: 0 }, todayDate: '', currencyCode: currency || '', series: { last30: [] } });
              }

              // Check for mixed currencies
              const currencies = new Set(migratedHistory.map(h => h.currency).filter(Boolean));
              let resolvedCurrency = currency;
              if (currencies.size > 1) {
                console.warn('Mixed currencies detected in savings history:', Array.from(currencies));
                resolvedCurrency = ''; // Empty currency code for mixed currencies
              } else if (currencies.size === 1) {
                resolvedCurrency = Array.from(currencies)[0];
              }

              // Determine today as newest entry
              const todayStr = migratedHistory.map(h => h.date).sort((a,b)=>a<b?-1:a>b?1:0).pop();
              const todayDate = new Date(`${todayStr}T00:00:00`);
              const last7Cutoff = new Date(todayDate); last7Cutoff.setDate(todayDate.getDate() - 6);
              const last30Cutoff = new Date(todayDate); last30Cutoff.setDate(todayDate.getDate() - 29);
              const jsDay = todayDate.getDay();
              const offsetToMonday = (jsDay + 6) % 7;
              const startOfWeek = new Date(todayDate); startOfWeek.setDate(todayDate.getDate() - offsetToMonday);
              const startOfMonth = new Date(todayDate.getFullYear(), todayDate.getMonth(), 1);

              const sumInWindow = (cutoff) => migratedHistory
                .filter(h => { const d = new Date(`${h.date}T00:00:00`); return d >= cutoff && d <= todayDate; })
                .reduce((s, h) => {
                  const entryDecimals = h.decimals ?? decimals;
                  const majorValue = minorToMajor(h.totalMinor || 0, entryDecimals);
                  return s + majorValue;
                }, 0);

              const todayEntry = migratedHistory.find(h => h.date === todayStr);
              const todayDecimals = todayEntry?.decimals ?? decimals;
              const today = Number((minorToMajor(todayEntry?.totalMinor || 0, todayDecimals)).toFixed(4));
              
              const yDate = new Date(todayDate); yDate.setDate(todayDate.getDate() - 1);
              const yStr = `${yDate.getFullYear()}-${String(yDate.getMonth() + 1).padStart(2, '0')}-${String(yDate.getDate()).padStart(2, '0')}`;
              const yesterdayEntry = migratedHistory.find(h => h.date === yStr);
              const yesterdayDecimals = yesterdayEntry?.decimals ?? decimals;
              const yesterday = Number((minorToMajor(yesterdayEntry?.totalMinor || 0, yesterdayDecimals)).toFixed(4));
              
              const last7Days = Number(sumInWindow(last7Cutoff).toFixed(4));
              const last30Days = Number(sumInWindow(last30Cutoff).toFixed(4));
              const weekToDate = Number(sumInWindow(startOfWeek).toFixed(4));
              const monthToDate = Number(sumInWindow(startOfMonth).toFixed(4));

              // All-time if earlier than last30Cutoff exists
              let allTime;
              const earliest = migratedHistory.map(h => h.date).sort((a,b)=>a<b?-1:a>b?1:0)[0];
              if (earliest && new Date(`${earliest}T00:00:00`) < last30Cutoff) {
                allTime = Number(migratedHistory.reduce((s, h) => {
                  const entryDecimals = h.decimals ?? decimals;
                  const majorValue = minorToMajor(h.totalMinor || 0, entryDecimals);
                  return s + majorValue;
                }, 0).toFixed(4));
              }

              // Build series
              const seriesLast30 = [];
              for (let i = 0; i < 30; i++) {
                const d = new Date(last30Cutoff); d.setDate(last30Cutoff.getDate() + i);
                const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                const entry = migratedHistory.find(h => h.date === ds);
                const entryDecimals = entry?.decimals ?? decimals;
                const majorValue = entry ? minorToMajor(entry.totalMinor || 0, entryDecimals) : 0;
                seriesLast30.push({ date: ds, total: Number(majorValue) });
              }

              resolve({
                success: true,
                summary: { today, yesterday, weekToDate, last7Days, monthToDate, last30Days, ...(allTime !== undefined ? { allTime } : {}) },
                todayDate: todayStr,
                currencyCode: resolvedCurrency || '',
                series: { last30: seriesLast30 }
              });
            });
          } catch (e) {
            reject(e);
          }
        });
      }
      // Minimal bar chart renderer
      function drawBarChart(canvasId, data) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !canvas.getContext) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);

        if (!Array.isArray(data) || data.length === 0) return;
        const values = data.map(d => Number(d.total || 0));
        const maxVal = Math.max(1, ...values);

        const padding = 6;
        const barGap = 2;
        const barCount = data.length;
        const plotW = w - padding * 2;
        const plotH = h - padding * 2;
        const barW = Math.max(1, Math.floor((plotW - barGap * (barCount - 1)) / barCount));

        // Axes baseline
        ctx.strokeStyle = '#ddd';
        ctx.beginPath();
        ctx.moveTo(padding, h - padding);
        ctx.lineTo(w - padding, h - padding);
        ctx.stroke();

        // Bars
        for (let i = 0; i < barCount; i++) {
          const val = values[i];
          const barH = Math.round((val / maxVal) * (plotH - 10));
          const x = padding + i * (barW + barGap);
          const y = h - padding - barH;
          ctx.fillStyle = i >= barCount - 7 ? '#4a90e2' : '#9ec5ff'; // last 7 highlighted for 30-day chart
          if (barCount <= 7) ctx.fillStyle = '#4a90e2';
          ctx.fillRect(x, y, barW, barH);
        }

        // Top marker for max
        ctx.fillStyle = '#999';
        ctx.font = '10px sans-serif';
        ctx.fillText(`max ${maxVal.toFixed(2)}`, padding, padding + 10);
      }

      // Function to view thermal model data
      function viewThermalModelData() {
        console.log('View thermal model data button clicked');

        // Disable button and show loading state
        document.getElementById('view_thermal_data').disabled = true;
        document.getElementById('trigger_result').textContent = "Fetching thermal model data...";

        // Call the API
        HomeyInstance.api('GET', '/getThermalModelData', {}, function(err, result) {
          if (err) {
            console.error('Error fetching thermal model data:', err);
            document.getElementById('view_thermal_data').disabled = false;
            document.getElementById('trigger_result').textContent = "Error: " + err.message;
            return HomeyInstance.alert(err.message);
          }

          console.log('Thermal model data fetched successfully:', result);

          if (result.success && result.data) {
            const data = result.data;

            // Format the data for display
            let message = `Thermal Model Data:\n\n`;
            message += `Optimization Count: ${data.optimizationCount} data points\n`;
            message += `Current K-Factor: ${data.kFactor !== null ? data.kFactor.toFixed(2) : 'Not set'}\n\n`;

            if (data.lastCalibration) {
              const calibDate = new Date(data.lastCalibration.timestamp).toLocaleString();
              message += `Last Calibration: ${calibDate}\n`;
              message += `K-Factor Change: ${data.lastCalibration.oldK.toFixed(2)} → ${data.lastCalibration.newK.toFixed(2)}\n`;
              message += `Analysis: ${data.lastCalibration.analysis}\n\n`;
            } else {
              message += `Last Calibration: Never performed\n\n`;
            }

            if (data.lastOptimization) {
              const optDate = new Date(data.lastOptimization.timestamp).toLocaleString();
              message += `Last Optimization: ${optDate}\n`;
              message += `Target Temperature: ${data.lastOptimization.targetTemp !== undefined ? data.lastOptimization.targetTemp : 'N/A'}°C (was ${data.lastOptimization.targetOriginal !== undefined ? data.lastOptimization.targetOriginal : 'N/A'}°C)\n`;
              message += `Indoor Temperature: ${data.lastOptimization.indoorTemp !== undefined ? data.lastOptimization.indoorTemp : 'N/A'}°C\n`;
              message += `Outdoor Temperature: ${data.lastOptimization.outdoorTemp !== undefined ? data.lastOptimization.outdoorTemp : 'N/A'}°C\n`;
              message += `Current Price: ${data.lastOptimization.priceNow !== undefined ? data.lastOptimization.priceNow.toFixed(4) : 'N/A'}\n`;
            }

            // Show the data in an alert
            HomeyInstance.alert(message);
          } else {
            HomeyInstance.alert('No thermal model data available yet. Run hourly optimization to collect data.');
          }

          // Enable the button and update the result text
          document.getElementById('view_thermal_data').disabled = false;
          document.getElementById('trigger_result').textContent = "Thermal model data retrieved successfully!";
        });
      }

      // Function to manage scheduled jobs
      function manageScheduledJobs() {
        console.log('Manage scheduled jobs button clicked');

        // Disable button and show loading state
        document.getElementById('manage_cron').disabled = true;
        document.getElementById('trigger_result').textContent = "Checking scheduled jobs status...";

        // First check the current status
        HomeyInstance.api('GET', '/getCheckCronStatus', {}, function(err, result) {
          if (err) {
            console.error('Error checking cron status:', err);
            document.getElementById('manage_cron').disabled = false;
            document.getElementById('trigger_result').textContent = "Error: " + err.message;
            return HomeyInstance.alert(err.message);
          }

          console.log('Cron status check successful:', result);

          // Format the result for display
          const hourlyStatus = result.hourlyJob.running ? 'Running' : 'Not running';
          const weeklyStatus = result.weeklyJob.running ? 'Running' : 'Not running';
          const hourlyNextRun = new Date(result.hourlyJob.nextRun).toLocaleString();
          const weeklyNextRun = new Date(result.weeklyJob.nextRun).toLocaleString();
          const lastHourlyRun = result.lastHourlyRun ? new Date(result.lastHourlyRun).toLocaleString() : 'Never';
          const lastWeeklyRun = result.lastWeeklyRun ? new Date(result.lastWeeklyRun).toLocaleString() : 'Never';

          // Create a formatted message
          const statusMessage = `
            Current time: ${new Date(result.currentTime).toLocaleString()}

            Hourly job: ${hourlyStatus}
            Next run: ${hourlyNextRun}
            Last run: ${lastHourlyRun}

            Weekly job: ${weeklyStatus}
            Next run: ${weeklyNextRun}
            Last run: ${lastWeeklyRun}
          `;

          // Ask the user what they want to do
          if (confirm(statusMessage + '\n\nDo you want to restart the scheduled jobs?')) {
            // User clicked OK, start/restart the jobs
            document.getElementById('trigger_result').textContent = "Starting scheduled jobs...";

            // Call the API to start cron jobs
            HomeyInstance.api('GET', '/getStartCronJobs', {}, function(startErr, startResult) {
              if (startErr) {
                console.error('Error starting cron jobs:', startErr);
                document.getElementById('manage_cron').disabled = false;
                document.getElementById('trigger_result').textContent = "Error: " + startErr.message;
                return HomeyInstance.alert(startErr.message);
              }

              console.log('Cron jobs started successfully:', startResult);

              // Create a formatted message
              const startMessage = `
                Scheduled jobs started successfully!

                Hourly job running: ${startResult.hourlyJobRunning ? 'Yes' : 'No'}
                Weekly job running: ${startResult.weeklyJobRunning ? 'Yes' : 'No'}
              `;

              // Show the status in an alert
              HomeyInstance.alert(startMessage);

              // Enable the button and update the result text
              document.getElementById('manage_cron').disabled = false;
              document.getElementById('trigger_result').textContent = "Scheduled jobs started successfully!";
            });
          } else {
            // User clicked Cancel, just enable the button
            document.getElementById('manage_cron').disabled = false;
            document.getElementById('trigger_result').textContent = "Scheduled jobs status checked successfully!";
          }
        });
      }

      // Function to check memory usage
      function checkMemoryUsage() {
        console.log('Check memory usage button clicked');

        // Disable button and show loading state
        document.getElementById('check_memory').disabled = true;
        document.getElementById('memory_result').textContent = "Checking memory usage...";

        // Call the API
        HomeyInstance.api('GET', '/getMemoryUsage', {}, function(err, result) {
          if (err) {
            console.error('Error calling /getMemoryUsage:', err);
            document.getElementById('check_memory').disabled = false;
            document.getElementById('memory_result').textContent = "Error: " + err.message;
            return HomeyInstance.alert(err.message);
          }

          console.log('/getMemoryUsage called successfully:', result);

          // Format and display the memory usage statistics
          let statsHtml = '';

          if (result.success) {
            // Process memory
            statsHtml += `Process Memory:\n`;
            statsHtml += `- RSS: ${result.processMemory.rss} MB\n`;
            statsHtml += `- Heap Total: ${result.processMemory.heapTotal} MB\n`;
            statsHtml += `- Heap Used: ${result.processMemory.heapUsed} MB\n`;
            statsHtml += `- External: ${result.processMemory.external} MB\n\n`;

            // Thermal model memory
            if (result.thermalModelMemory) {
              statsHtml += `Thermal Model Data:\n`;
              statsHtml += `- Data Points: ${result.thermalModelMemory.dataPointCount}\n`;
              statsHtml += `- Aggregated Data Points: ${result.thermalModelMemory.aggregatedDataCount}\n`;
              statsHtml += `- Estimated Memory Usage: ${result.thermalModelMemory.estimatedMemoryUsageKB} KB\n`;
              statsHtml += `- Data Points Per Day: ${result.thermalModelMemory.dataPointsPerDay}\n\n`;

              // Model characteristics
              statsHtml += `Model Characteristics:\n`;
              statsHtml += `- Heating Rate: ${result.thermalModelMemory.modelCharacteristics.heatingRate.toFixed(4)}\n`;
              statsHtml += `- Cooling Rate: ${result.thermalModelMemory.modelCharacteristics.coolingRate.toFixed(4)}\n`;
              statsHtml += `- Outdoor Temp Impact: ${result.thermalModelMemory.modelCharacteristics.outdoorTempImpact.toFixed(4)}\n`;
              statsHtml += `- Wind Impact: ${result.thermalModelMemory.modelCharacteristics.windImpact.toFixed(4)}\n`;
              statsHtml += `- Thermal Mass: ${result.thermalModelMemory.modelCharacteristics.thermalMass.toFixed(4)}\n`;
              statsHtml += `- Model Confidence: ${result.thermalModelMemory.modelCharacteristics.modelConfidence.toFixed(4)}\n`;
              statsHtml += `- Last Updated: ${result.thermalModelMemory.modelCharacteristics.lastUpdated}\n`;
            } else {
              statsHtml += `Thermal Model Data: Not available\n`;
            }

            // Timestamp
            statsHtml += `\nTimestamp: ${result.timestamp}`;

            // Show the stats container
            document.getElementById('memory_stats').style.display = 'block';
            document.getElementById('memory_stats_content').textContent = statsHtml;

            // Show success message
            document.getElementById('memory_result').textContent = "Memory usage statistics retrieved successfully.";
          } else {
            document.getElementById('memory_result').textContent = "Error retrieving memory usage: " + result.message;
            document.getElementById('memory_stats').style.display = 'none';
          }

          // Enable the button
          document.getElementById('check_memory').disabled = false;
        });
      }

      // Function to run data cleanup
      function runDataCleanup() {
        console.log('Run data cleanup button clicked');

        // Confirm before running cleanup
        HomeyInstance.confirm(
          'Run Data Cleanup',
          'This will aggregate older data points to reduce memory usage. Continue?',
          function(err, confirmed) {
            if (err) {
              return HomeyInstance.alert(err);
            }

            if (confirmed) {
              // Disable button and show loading state
              document.getElementById('run_cleanup').disabled = true;
              document.getElementById('memory_result').textContent = "Running data cleanup...";

              // Call the API
              HomeyInstance.api('GET', '/runThermalDataCleanup', {}, function(err, result) {
                if (err) {
                  console.error('Error calling /runThermalDataCleanup:', err);
                  document.getElementById('run_cleanup').disabled = false;
                  document.getElementById('memory_result').textContent = "Error: " + err.message;
                  return HomeyInstance.alert(err.message);
                }

                console.log('/runThermalDataCleanup called successfully:', result);

                if (result.success) {
                  // Format and display the cleanup results
                  let resultMessage = `Cleanup successful!\n`;
                  resultMessage += `- Data points: ${result.dataPointsBefore} → ${result.dataPointsAfter}\n`;
                  resultMessage += `- Aggregated points: ${result.aggregatedPointsBefore} → ${result.aggregatedPointsAfter}\n`;
                  resultMessage += `- Memory usage: ${result.memoryUsageBefore}KB → ${result.memoryUsageAfter}KB\n`;
                  resultMessage += `- Saved: ${result.memoryUsageBefore - result.memoryUsageAfter}KB`;

                  // Show the results
                  document.getElementById('memory_result').textContent = resultMessage;

                  // Refresh memory stats
                  checkMemoryUsage();
                } else {
                  document.getElementById('memory_result').textContent = "Error running data cleanup: " + result.message;
                }

                // Enable the button
                document.getElementById('run_cleanup').disabled = false;
              });
            }
          }
        );
      }

      function onHomeyReady(Homey) {
        console.log('onHomeyReady called - Settings page initialized');

        // Store Homey instance globally
        HomeyInstance = Homey;

        // Tell Homey we're ready to be displayed
        Homey.ready();
        console.log('Homey.ready() called');

        // Get elements
        const melcloudUserElement = document.getElementById("melcloud_user");
        const melcloudPassElement = document.getElementById("melcloud_pass");
        const deviceIdElement = document.getElementById("device_id");
        const buildingIdElement = document.getElementById("building_id");
        const refreshDevicesButton = document.getElementById("refresh_devices");
        const deviceRefreshStatus = document.getElementById("device_refresh_status");
        const showManualEntryElement = document.getElementById("show_manual_entry");
        const manualIdEntryDiv = document.getElementById("manual_id_entry");
        const manualDeviceIdElement = document.getElementById("manual_device_id");
        const manualBuildingIdElement = document.getElementById("manual_building_id");
        const tibberTokenElement = document.getElementById("tibber_token");
        const minTempElement = document.getElementById("min_temp");
        const maxTempElement = document.getElementById("max_temp");
        const useWeatherDataElement = document.getElementById("use_weather_data");
        const latitudeElement = document.getElementById("latitude");
        const longitudeElement = document.getElementById("longitude");
        const detectLocationButton = document.getElementById("detect-location");
        const dayStartHourElement = document.getElementById("day_start_hour");
        const dayEndHourElement = document.getElementById("day_end_hour");
        const nightTempReductionElement = document.getElementById("night_temp_reduction");
        const preHeatHoursElement = document.getElementById("pre_heat_hours");
        const timeZoneOffsetElement = document.getElementById("time_zone_offset");
        const useDstElement = document.getElementById("use_dst");
        const logLevelElement = document.getElementById("log_level");
        const notifyOnSuccessElement = document.getElementById("notify_on_success");
        const currencyCodeElement = document.getElementById("currency_code");
        const saveElement = document.getElementById("save");

        // Zone2 elements
        const enableZone2Element = document.getElementById("enable_zone2");
        const zone2SettingsDiv = document.getElementById("zone2_settings");
        const zone2Fieldset = document.getElementById("zone2_fieldset");
        const minTempZone2Element = document.getElementById("min_temp_zone2");
        const maxTempZone2Element = document.getElementById("max_temp_zone2");
        const tempStepZone2Element = document.getElementById("temp_step_zone2");

        // COP settings elements
        const copWeightElement = document.getElementById("cop_weight");
        const autoSeasonalModeElement = document.getElementById("auto_seasonal_mode");
        const summerModeElement = document.getElementById("summer_mode");
        const summerModeContainer = document.getElementById("summer_mode_container");

        // Hot water tank elements
        const enableTankControlElement = document.getElementById("enable_tank_control");
        const minTankTempElement = document.getElementById("min_tank_temp");
        const maxTankTempElement = document.getElementById("max_tank_temp");
        const tankTempStepElement = document.getElementById("tank_temp_step");
        const tankFieldset = document.getElementById("tank_fieldset");
        const tankCapabilityWarning = document.getElementById("tank_capability_warning");

        // Engine elements
        const useEngineElement = document.getElementById("use_engine");
        const deadbandElement = document.getElementById("deadband_c");
        const minChangeMinutesElement = document.getElementById("min_setpoint_change_minutes");
        const extremeMinElement = document.getElementById("extreme_weather_min_temp");
        const occupiedElement = document.getElementById("occupied");
        const comfortLowerOccElement = document.getElementById("comfort_lower_occupied");
        const comfortUpperOccElement = document.getElementById("comfort_upper_occupied");
        const comfortLowerAwayElement = document.getElementById("comfort_lower_away");
        const comfortUpperAwayElement = document.getElementById("comfort_upper_away");
        const preheatEnableElement = document.getElementById("preheat_enable");
        const preheatHorizonElement = document.getElementById("preheat_horizon_hours");
        const preheatPercentileElement = document.getElementById("preheat_cheap_percentile");

        // Weather location warning helper
        function updateWeatherLocationWarning() {
          const warn = document.getElementById('weather_location_warning');
          if (!warn) return;
          const enabled = useWeatherDataElement.checked;
          const latOk = latitudeElement.value !== '' && !isNaN(parseFloat(latitudeElement.value));
          const lonOk = longitudeElement.value !== '' && !isNaN(parseFloat(longitudeElement.value));
          warn.style.display = enabled && (!latOk || !lonOk) ? 'block' : 'none';
        }
        useWeatherDataElement.addEventListener('change', updateWeatherLocationWarning);
        latitudeElement.addEventListener('input', updateWeatherLocationWarning);
        longitudeElement.addEventListener('input', updateWeatherLocationWarning);
        
        // Removed: unused hot water pattern inputs (UI-only previously)
        const resetPatternsButton = document.getElementById("reset_patterns");
        const clearAllDataButton = document.getElementById("clear_all_data");
        // Buttons now use onclick attributes with global functions

        // Load current settings
        Homey.get("melcloud_user", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) melcloudUserElement.value = value;
        });

        Homey.get("melcloud_pass", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) melcloudPassElement.value = value;
        });

        // Store the saved device and building IDs to use after loading the device list
        let savedDeviceId = null;
        let savedBuildingId = null;

        // Get the saved device ID
        Homey.get("device_id", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) {
            savedDeviceId = value;
            // Also set it in the manual entry field
            manualDeviceIdElement.value = value;
          }
        });

        // Get the saved building ID
        Homey.get("building_id", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) {
            savedBuildingId = value;
            // Also set it in the manual entry field
            manualBuildingIdElement.value = value;

            // After getting both saved IDs, try to load the device list
            loadDeviceList(savedDeviceId, savedBuildingId);
          }
        });

        Homey.get("tibber_token", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) tibberTokenElement.value = value;
        });



        Homey.get("min_temp", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) minTempElement.value = value;
        });

        Homey.get("max_temp", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) maxTempElement.value = value;
        });

        // Load engine settings
        Homey.get("use_engine", function (err, value) { if (!err && value !== undefined) useEngineElement.checked = !!value; });
        Homey.get("deadband_c", function (err, value) { if (!err && value !== undefined) deadbandElement.value = value; });
        Homey.get("min_setpoint_change_minutes", function (err, value) { if (!err && value !== undefined) minChangeMinutesElement.value = value; });
        Homey.get("extreme_weather_min_temp", function (err, value) { if (!err && value !== undefined) extremeMinElement.value = value; });
        Homey.get("occupied", function (err, value) { if (!err && value !== undefined) occupiedElement.checked = !!value; });
        Homey.get("comfort_lower_occupied", function (err, value) { if (!err && value !== undefined) comfortLowerOccElement.value = value; });
        Homey.get("comfort_upper_occupied", function (err, value) { if (!err && value !== undefined) comfortUpperOccElement.value = value; });
        Homey.get("comfort_lower_away", function (err, value) { if (!err && value !== undefined) comfortLowerAwayElement.value = value; });
        Homey.get("comfort_upper_away", function (err, value) { if (!err && value !== undefined) comfortUpperAwayElement.value = value; });
        Homey.get("preheat_enable", function (err, value) { if (!err && value !== undefined) preheatEnableElement.checked = !!value; });
        Homey.get("preheat_horizon_hours", function (err, value) { if (!err && value !== undefined) preheatHorizonElement.value = value; });
        Homey.get("preheat_cheap_percentile", function (err, value) { if (!err && value !== undefined) preheatPercentileElement.value = value; });

        Homey.get("log_level", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) logLevelElement.value = value;
        });

        Homey.get("notify_on_success", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) notifyOnSuccessElement.checked = !!value;
        });

        Homey.get("currency", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined && value !== null) currencyCodeElement.value = value;
        });

        Homey.get("use_weather_data", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) useWeatherDataElement.checked = value;
          updateWeatherLocationWarning();
        });

        Homey.get("latitude", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) latitudeElement.value = value;
          updateWeatherLocationWarning();
        });

        Homey.get("longitude", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) longitudeElement.value = value;
          updateWeatherLocationWarning();
        });

        // Load comfort profile settings
        Homey.get("day_start_hour", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) dayStartHourElement.value = value;
        });

        Homey.get("day_end_hour", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) dayEndHourElement.value = value;
        });

        Homey.get("night_temp_reduction", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) nightTempReductionElement.value = value;
        });

        Homey.get("pre_heat_hours", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) preHeatHoursElement.value = value;
        });

        // Load time zone settings
        Homey.get("time_zone_offset", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) timeZoneOffsetElement.value = value;
        });

        Homey.get("use_dst", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) useDstElement.checked = value;
        });

        // Load Zone2 settings
        Homey.get("enable_zone2", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) {
            enableZone2Element.checked = value;
            zone2SettingsDiv.style.display = value ? 'block' : 'none';
          }
        });

        Homey.get("min_temp_zone2", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) minTempZone2Element.value = value;
        });

        Homey.get("max_temp_zone2", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) maxTempZone2Element.value = value;
        });

        Homey.get("temp_step_zone2", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) tempStepZone2Element.value = value;
        });

        // Manual entry controls are not persisted; default to hidden
        showManualEntryElement.checked = false;
        manualIdEntryDiv.style.display = 'none';

        // Load hot water tank settings
        Homey.get("enable_tank_control", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) enableTankControlElement.checked = value;
        });

        Homey.get("min_tank_temp", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) minTankTempElement.value = value;
        });

        Homey.get("max_tank_temp", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) maxTankTempElement.value = value;
        });

        Homey.get("tank_temp_step", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) tankTempStepElement.value = value;
        });
        
        // Removed: loads for unused hot water pattern settings

        // Load COP settings
        Homey.get("cop_weight", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) copWeightElement.value = value;
        });

        Homey.get("auto_seasonal_mode", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) {
            autoSeasonalModeElement.checked = value;
            // Show/hide summer mode based on auto seasonal mode
            summerModeContainer.style.opacity = value ? '0.5' : '1';
            summerModeElement.disabled = value;
          }
        });

        Homey.get("summer_mode", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) summerModeElement.checked = value;
        });

        // Function to load the device list and select the saved device and building IDs
        function loadDeviceList(savedDeviceId, savedBuildingId) {
          console.log('Loading device list with saved IDs:', { savedDeviceId, savedBuildingId });

          // Show loading state
          deviceRefreshStatus.textContent = "Loading devices...";

          // Call the API to get the device list
          HomeyInstance.api('GET', '/getDeviceList', {}, function(err, result) {
            if (err) {
              console.error('Error getting device list:', err);
              deviceRefreshStatus.textContent = "Error: " + err.message;

              // If we can't load the device list but have saved IDs, show the manual entry fields
              if (savedDeviceId || savedBuildingId) {
                showManualEntryElement.checked = true;
                manualIdEntryDiv.style.display = 'block';
              }

              return;
            }

            console.log('Device list retrieved successfully:', result);

            // Clear existing options
            while (buildingIdElement.options.length > 1) {
              buildingIdElement.remove(1);
            }

            while (deviceIdElement.options.length > 1) {
              deviceIdElement.remove(1);
            }

            // Add buildings to the dropdown
            let foundSavedBuilding = false;
            if (result.buildings && result.buildings.length > 0) {
              result.buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.text = building.name || `Building ${building.id}`;
                buildingIdElement.add(option);

                // Check if this is the saved building ID
                if (savedBuildingId && building.id == savedBuildingId) {
                  foundSavedBuilding = true;
                }
              });
            }

            // Add devices to the dropdown
            let foundSavedDevice = false;
            if (result.devices && result.devices.length > 0) {
              result.devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.text = device.name || `Device ${device.id}`;
                option.dataset.buildingId = device.buildingId;
                option.dataset.hasZone1 = device.hasZone1;
                option.dataset.hasZone2 = device.hasZone2;
                option.dataset.hasTank = device.hasTank;
                if (device.type) option.dataset.type = device.type;
                if (device.SetTankWaterTemperature !== undefined) option.dataset.settankwatertemperature = device.SetTankWaterTemperature;
                if (device.TankWaterTemperature !== undefined) option.dataset.tankwatertemperature = device.TankWaterTemperature;
                deviceIdElement.add(option);

                // Check if this is the saved device ID
                if (savedDeviceId && device.id == savedDeviceId) {
                  foundSavedDevice = true;
                  deviceIdElement.value = device.id;

                  // Also select the building ID
                  buildingIdElement.value = device.buildingId;

                  // Check if the device has Zone2 and enable/disable the Zone2 settings accordingly
                  if (device.hasZone2) {
                    enableZone2Element.disabled = false;
                    document.querySelector('label[for="enable_zone2"]').style.opacity = 1;
                    zone2Fieldset.style.display = '';
                  } else {
                    enableZone2Element.disabled = true;
                    document.querySelector('label[for="enable_zone2"]').style.opacity = 0.5;
                    zone2Fieldset.style.display = 'none';
                  }

                  // Tank capability (check by device type and actual tank temperature support)
                  const t = (device.type || '').toString().toLowerCase();
                  const typeHasTank = t.includes('atw') || t.includes('boiler') || t.includes('tank') || t.includes('heat_pump');
                  const deviceHasTankData = device.SetTankWaterTemperature !== undefined || device.TankWaterTemperature !== undefined || device.hasTank;
                  const likelyHasTank = typeHasTank || deviceHasTankData;
                  
                  if (likelyHasTank) {
                    tankFieldset.style.display = '';
                    tankCapabilityWarning.style.display = 'none';
                  } else {
                    tankFieldset.style.display = 'none';
                    enableTankControlElement.checked = false;
                  }
                }
              });

              deviceRefreshStatus.textContent = `Found ${result.devices.length} devices`;
            } else {
              deviceRefreshStatus.textContent = "No devices found";
            }

            // If we couldn't find the saved device or building ID in the list, show the manual entry fields
            if ((savedDeviceId && !foundSavedDevice) || (savedBuildingId && !foundSavedBuilding)) {
              showManualEntryElement.checked = true;
              manualIdEntryDiv.style.display = 'block';
            }
          });
        }

        // Add event listener for the refresh devices button
        refreshDevicesButton.addEventListener('click', function(e) {
          e.preventDefault();

          // Disable the button and show loading state
          refreshDevicesButton.disabled = true;
          deviceRefreshStatus.textContent = "Loading devices...";

          // Get the current saved IDs
          const currentDeviceId = deviceIdElement.value || manualDeviceIdElement.value;
          const currentBuildingId = buildingIdElement.value || manualBuildingIdElement.value;

          // Call the loadDeviceList function
          loadDeviceList(currentDeviceId, currentBuildingId);

          refreshDevicesButton.disabled = false;
        });

        // Add event listener for the device selection to update building selection
        deviceIdElement.addEventListener('change', function() {
          const selectedOption = deviceIdElement.options[deviceIdElement.selectedIndex];

          if (selectedOption && selectedOption.dataset.buildingId) {
            buildingIdElement.value = selectedOption.dataset.buildingId;

            // Check if the device has Zone2 and enable/disable the Zone2 settings accordingly
            if (selectedOption.dataset.hasZone2 === "true") {
              enableZone2Element.disabled = false;
              document.querySelector('label[for="enable_zone2"]').style.opacity = 1;
              zone2Fieldset.style.display = '';
            } else {
              enableZone2Element.disabled = true;
              enableZone2Element.checked = false;
              zone2SettingsDiv.style.display = 'none';
              document.querySelector('label[for="enable_zone2"]').style.opacity = 0.5;
              zone2Fieldset.style.display = 'none';
            }

            // Tank capability (check by device type and actual tank temperature support)
            const t = (selectedOption.dataset.type || '').toString().toLowerCase();
            const typeHasTank = t.includes('atw') || t.includes('boiler') || t.includes('tank') || t.includes('heat_pump');
            const deviceHasTankData = selectedOption.dataset.settankwatertemperature !== undefined || selectedOption.dataset.tankwatertemperature !== undefined || selectedOption.dataset.hastank === "true";
            const likelyHasTank = typeHasTank || deviceHasTankData;
            
            if (likelyHasTank) {
              tankFieldset.style.display = '';
              tankCapabilityWarning.style.display = 'none';
            } else {
              tankFieldset.style.display = 'none';
              enableTankControlElement.checked = false;
            }
          }
        });

        // Add event listener for the show manual entry checkbox
        showManualEntryElement.addEventListener('change', function() {
          manualIdEntryDiv.style.display = this.checked ? 'block' : 'none';
        });

        // Add event listener for the enable Zone2 checkbox
        enableZone2Element.addEventListener('change', function() {
          zone2SettingsDiv.style.display = this.checked ? 'block' : 'none';
        });

        // Add event listener for the Auto Seasonal Mode checkbox
        autoSeasonalModeElement.addEventListener('change', function() {
          // When Auto Seasonal Mode is enabled, disable Summer Mode
          summerModeElement.disabled = this.checked;
          summerModeContainer.style.opacity = this.checked ? '0.5' : '1';
        });

        // Add event listener for the detect location button
        detectLocationButton.addEventListener('click', function(e) {
          e.preventDefault();

          // Show a message that this is a browser-based feature
          Homey.alert('This feature uses your browser\'s location. Please allow location access when prompted.');

          // Use browser geolocation API
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function(position) {
                // Success callback
                latitudeElement.value = position.coords.latitude;
                longitudeElement.value = position.coords.longitude;
                Homey.alert('Location detected successfully! Please save your settings.');
              },
              function(error) {
                // Error callback
                let errorMessage = 'Could not detect your location. ';
                switch(error.code) {
                  case error.PERMISSION_DENIED:
                    errorMessage += 'Location permission was denied.';
                    break;
                  case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable.';
                    break;
                  case error.TIMEOUT:
                    errorMessage += 'The request to get location timed out.';
                    break;
                  default:
                    errorMessage += 'An unknown error occurred.';
                    break;
                }
                Homey.alert(errorMessage);
              }
            );
          } else {
            Homey.alert('Geolocation is not supported by your browser. Please enter coordinates manually.');
          }
        });

        // Save settings
        saveElement.addEventListener("click", function (e) {
          // Save all settings
          Homey.set("melcloud_user", melcloudUserElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("melcloud_pass", melcloudPassElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          // Save device and building IDs based on selection or manual entry
          if (showManualEntryElement.checked && manualDeviceIdElement.value) {
            Homey.set("device_id", manualDeviceIdElement.value, function (err) {
              if (err) return Homey.alert(err);
            });

            Homey.set("building_id", parseInt(manualBuildingIdElement.value) || 0, function (err) {
              if (err) return Homey.alert(err);
            });
          } else {
            Homey.set("device_id", deviceIdElement.value, function (err) {
              if (err) return Homey.alert(err);
            });

            Homey.set("building_id", parseInt(buildingIdElement.value) || 0, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          // Do not persist UI-only manual entry settings

          Homey.set("tibber_token", tibberTokenElement.value, function (err) {
            if (err) return Homey.alert(err);
          });



          Homey.set("min_temp", parseFloat(minTempElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("max_temp", parseFloat(maxTempElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("log_level", parseInt(logLevelElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("notify_on_success", notifyOnSuccessElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          // Save currency code (optional)
          const code = (currencyCodeElement.value || '').trim();
          if (code) {
            const normalized = code.toUpperCase();
            if (/^[A-Z]{3}$/.test(normalized)) {
              Homey.set("currency", normalized, function (err) {
                if (err) return Homey.alert(err);
              });
            } else {
              Homey.alert('Invalid currency code. Use a 3-letter ISO code like NOK, SEK, EUR.');
              return;
            }
          } else {
            // Clear custom currency if input empty
            Homey.set("currency", '', function (err) {
              if (err) return Homey.alert(err);
            });
          }

          Homey.set("use_weather_data", useWeatherDataElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          // Save location settings
          const latitude = parseFloat(latitudeElement.value);
          const longitude = parseFloat(longitudeElement.value);

          if (!isNaN(latitude) && latitude >= -90 && latitude <= 90) {
            Homey.set("latitude", latitude, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (latitudeElement.value) {
            Homey.alert('Invalid latitude value. Must be between -90 and 90.');
            return;
          }

          if (!isNaN(longitude) && longitude >= -180 && longitude <= 180) {
            Homey.set("longitude", longitude, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (longitudeElement.value) {
            Homey.alert('Invalid longitude value. Must be between -180 and 180.');
            return;
          }

          // Save comfort profile settings
          const dayStartHour = parseInt(dayStartHourElement.value);
          if (!isNaN(dayStartHour) && dayStartHour >= 0 && dayStartHour <= 23) {
            Homey.set("day_start_hour", dayStartHour, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          const dayEndHour = parseInt(dayEndHourElement.value);
          if (!isNaN(dayEndHour) && dayEndHour >= 0 && dayEndHour <= 23) {
            Homey.set("day_end_hour", dayEndHour, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          const nightTempReduction = parseFloat(nightTempReductionElement.value);
          if (!isNaN(nightTempReduction) && nightTempReduction >= 0 && nightTempReduction <= 5) {
            Homey.set("night_temp_reduction", nightTempReduction, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          const preHeatHours = parseFloat(preHeatHoursElement.value);
          if (!isNaN(preHeatHours) && preHeatHours >= 0 && preHeatHours <= 3) {
            Homey.set("pre_heat_hours", preHeatHours, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          // Save time zone settings
          const timeZoneOffset = parseFloat(timeZoneOffsetElement.value);
          if (!isNaN(timeZoneOffset) && timeZoneOffset >= -12 && timeZoneOffset <= 14) {
            Homey.set("time_zone_offset", timeZoneOffset, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          Homey.set("use_dst", useDstElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          // Save COP settings
          const copWeight = parseFloat(copWeightElement.value);
          if (!isNaN(copWeight) && copWeight >= 0.0 && copWeight <= 1.0) {
            Homey.set("cop_weight", copWeight, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (copWeightElement.value) {
            Homey.alert('Invalid COP weight value. Must be between 0.0 and 1.0.');
            return;
          }

          Homey.set("auto_seasonal_mode", autoSeasonalModeElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("summer_mode", summerModeElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          // Save Engine settings
          Homey.set("use_engine", useEngineElement.checked, function (err) { if (err) return Homey.alert(err); });
          const deadband = parseFloat(deadbandElement.value);
          if (!isNaN(deadband) && deadband >= 0.1 && deadband <= 2.0) {
            Homey.set("deadband_c", deadband, function (err) { if (err) return Homey.alert(err); });
          } else if (deadbandElement.value) { Homey.alert('Invalid Deadband. 0.1–2.0°C'); return; }

          const minChange = parseInt(minChangeMinutesElement.value);
          if (!isNaN(minChange) && minChange >= 5 && minChange <= 180) {
            Homey.set("min_setpoint_change_minutes", minChange, function (err) { if (err) return Homey.alert(err); });
          } else if (minChangeMinutesElement.value) { Homey.alert('Invalid Min Setpoint Interval. 5–180 min'); return; }

          const extremeMin = parseFloat(extremeMinElement.value);
          if (!isNaN(extremeMin) && extremeMin >= 16 && extremeMin <= 23) {
            Homey.set("extreme_weather_min_temp", extremeMin, function (err) { if (err) return Homey.alert(err); });
          } else if (extremeMinElement.value) { Homey.alert('Invalid Extreme Cold Min. 16–23°C'); return; }

          Homey.set("occupied", occupiedElement.checked, function (err) { if (err) return Homey.alert(err); });

          const clo = parseFloat(comfortLowerOccElement.value);
          const cuo = parseFloat(comfortUpperOccElement.value);
          if (!isNaN(clo) && !isNaN(cuo) && clo >= 18 && clo <= 23 && cuo >= 19 && cuo <= 24 && clo < cuo) {
            Homey.set("comfort_lower_occupied", clo, function (err) { if (err) return Homey.alert(err); });
            Homey.set("comfort_upper_occupied", cuo, function (err) { if (err) return Homey.alert(err); });
          } else if (comfortLowerOccElement.value || comfortUpperOccElement.value) { Homey.alert('Invalid Occupied band. Lower 18–23, Upper 19–24, Lower < Upper'); return; }

          const cla = parseFloat(comfortLowerAwayElement.value);
          const cua = parseFloat(comfortUpperAwayElement.value);
          if (!isNaN(cla) && !isNaN(cua) && cla >= 17 && cla <= 22 && cua >= 18 && cua <= 23 && cla < cua) {
            Homey.set("comfort_lower_away", cla, function (err) { if (err) return Homey.alert(err); });
            Homey.set("comfort_upper_away", cua, function (err) { if (err) return Homey.alert(err); });
          } else if (comfortLowerAwayElement.value || comfortUpperAwayElement.value) { Homey.alert('Invalid Away band. Lower 17–22, Upper 18–23, Lower < Upper'); return; }

          Homey.set("preheat_enable", preheatEnableElement.checked, function (err) { if (err) return Homey.alert(err); });
          const horizon = parseInt(preheatHorizonElement.value);
          if (!isNaN(horizon) && horizon >= 6 && horizon <= 36) {
            Homey.set("preheat_horizon_hours", horizon, function (err) { if (err) return Homey.alert(err); });
          } else if (preheatHorizonElement.value) { Homey.alert('Invalid horizon. 6–36h'); return; }
          const pct = parseFloat(preheatPercentileElement.value);
          if (!isNaN(pct) && pct >= 0.05 && pct <= 0.5) {
            Homey.set("preheat_cheap_percentile", pct, function (err) { if (err) return Homey.alert(err); });
          } else if (preheatPercentileElement.value) { Homey.alert('Invalid cheap percentile. 0.05–0.5'); return; }

          // Save hot water tank settings
          Homey.set("enable_tank_control", enableTankControlElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          const minTankTemp = parseFloat(minTankTempElement.value);
          if (!isNaN(minTankTemp) && minTankTemp >= 30 && minTankTemp <= 45) {
            Homey.set("min_tank_temp", minTankTemp, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (minTankTempElement.value) {
            Homey.alert('Invalid minimum tank temperature value. Must be between 30 and 45.');
            return;
          }

          const maxTankTemp = parseFloat(maxTankTempElement.value);
          if (!isNaN(maxTankTemp) && maxTankTemp >= 40 && maxTankTemp <= 60) {
            Homey.set("max_tank_temp", maxTankTemp, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (maxTankTempElement.value) {
            Homey.alert('Invalid maximum tank temperature value. Must be between 40 and 60.');
            return;
          }

          // Validate min < max for tank temperature
          if (minTankTemp >= maxTankTemp) {
            Homey.alert('Minimum tank temperature must be less than maximum tank temperature.');
            return;
          }

          const tankTempStep = parseFloat(tankTempStepElement.value);
          if (!isNaN(tankTempStep) && tankTempStep >= 0.5 && tankTempStep <= 5.0) {
            Homey.set("tank_temp_step", tankTempStep, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (tankTempStepElement.value) {
            Homey.alert('Invalid tank temperature step value. Must be between 0.5 and 5.0.');
            return;
          }
          
          // Removed: persistence for unused hot water pattern settings

          // Save Zone2 settings
          Homey.set("enable_zone2", enableZone2Element.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          const minTempZone2 = parseFloat(minTempZone2Element.value);
          if (!isNaN(minTempZone2) && minTempZone2 >= 16 && minTempZone2 <= 22) {
            Homey.set("min_temp_zone2", minTempZone2, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (minTempZone2Element.value) {
            Homey.alert('Invalid minimum Zone2 temperature value. Must be between 16 and 22.');
            return;
          }

          const maxTempZone2 = parseFloat(maxTempZone2Element.value);
          if (!isNaN(maxTempZone2) && maxTempZone2 >= 20 && maxTempZone2 <= 26) {
            Homey.set("max_temp_zone2", maxTempZone2, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (maxTempZone2Element.value) {
            Homey.alert('Invalid maximum Zone2 temperature value. Must be between 20 and 26.');
            return;
          }

          // Validate min < max for Zone2 temperature
          if (minTempZone2 >= maxTempZone2) {
            Homey.alert('Minimum Zone2 temperature must be less than maximum Zone2 temperature.');
            return;
          }

          const tempStepZone2 = parseFloat(tempStepZone2Element.value);
          if (!isNaN(tempStepZone2) && tempStepZone2 >= 0.1 && tempStepZone2 <= 2.0) {
            Homey.set("temp_step_zone2", tempStepZone2, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (tempStepZone2Element.value) {
            Homey.alert('Invalid Zone2 temperature step value. Must be between 0.1 and 2.0.');
            return;
          }

          // Show success message
          Homey.alert('Settings saved successfully!');
        });

        // Button event handlers are now defined as global functions and attached via onclick attributes
      }
      
      // Hot water usage pattern functions
      function resetHotWaterPatterns() {
        const resultElement = document.getElementById('hot_water_action_result');
        resultElement.textContent = 'Resetting hot water usage patterns...';
        
        Homey.api('POST', '/hot-water/reset-patterns', {}, function(err, result) {
          if (err) {
            resultElement.textContent = 'Error: ' + (err.message || 'Failed to reset patterns');
            return;
          }
          resultElement.textContent = 'Hot water usage patterns have been reset to defaults.';
        });
      }
      
      function clearHotWaterData(keepAggregated = false) {
        const actionText = keepAggregated ? 
          'clear detailed hot water usage data but keep aggregated patterns' : 
          'clear ALL hot water usage data including patterns';
        
        if (confirm(`Are you sure you want to ${actionText}? This action cannot be undone.`)) {
          const resultElement = document.getElementById('hot_water_action_result');
          resultElement.textContent = `Clearing hot water usage data${keepAggregated ? ' (keeping aggregated data)' : ''}...`;
          
          Homey.api('POST', '/hot-water/clear-data', { clearAggregated: !keepAggregated }, function(err, result) {
            if (err) {
              resultElement.textContent = 'Error: ' + (err.message || 'Failed to clear data');
              return;
            }
            resultElement.textContent = result.message || 'Hot water usage data has been cleared.';
          });
        }
      }
    </script>
  </body>
</html>
