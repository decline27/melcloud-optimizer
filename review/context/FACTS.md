# MELCloud Optimizer — Facts & Invariants

## Domain Invariants
- **Zone 2 sentinel & capability hygiene** – `drivers/boiler/device.ts:268-314` treats `RoomTemperatureZone2 <= -30 °C` or empty `Zone2Name` as “no second zone.” It logs the raw reading and removes every `*.zone2` capability pair, then re-adds them whenever the sensor/name reappears; `-39 °C` is the MELCloud “sensor missing” value.
- **Setpoint quantization, rounding & dwell** – The optimizer boots with 18–22 °C bounds, 0.5 °C steps, 0.3 °C deadband, and a 30 min dwell timer for Zone 1 (`src/services/optimizer.ts:171-214`). Zone 2 inherits its own 18–22 °C band and 0.5 °C step; tank control defaults to 40–50 °C with a 0.5 °C step but user settings clamp it to 30–60 °C and 1–5 °C steps. Every proposal runs through `applySetpointConstraints` (`src/util/setpoint-constraints.ts:1-165`), which clamps min/max, enforces optional ramp limits, checks the deadband *before* rounding (Issue #2 fix), rounds to the discrete step, and blocks commands if the 30 min lockout hasn’t expired.
- **COP definitions & persistence** – Heating/DHW COPs come from MELCloud’s `Daily*EnergyProduced/Consumed` counters in `getDeviceState`/`getDailyEnergyTotals` (`src/services/melcloud-api.ts:627-777, 1155-1294`). `Optimizer` caches COP ranges in `copRange` and emits `OptimizationMetrics` (`src/services/optimizer.ts:1348-1438`), while `COPHelper` schedules daily/weekly/monthly jobs that compute produced/consumed energy and push snapshots into `cop_snapshots_daily|weekly|monthly` for later averaging (`src/services/cop-helper.ts:62-166`). Learned COP ranges are persisted under `cop_guards_v1` so normalization survives reboots (`src/services/optimizer.ts:237-274`).
- **Seasonal mode switching** – `src/services/optimizer.ts:1383-1459` sets `seasonalMode` to `summer` when heating < 1 kWh over the sampling window, `winter` when heating > 2× DHW, otherwise `transition`. Trend flags from enhanced COP history decide whether optimization focuses on heating, DHW, or both; the mode feeds adaptive price weights, COP thresholds, and comfort nudges (`src/services/optimizer.ts:1500-1605`).
- **Comfort bands & safety constraints** – Occupied defaults (20–21 °C) and away defaults (19–20.5 °C) come from Homey settings and are always clamped between 16 °C and 26 °C (`src/services/optimizer.ts:606-628`). Every temperature proposal references the current comfort band for clamp + baseline savings. The optimizer never writes temperatures that violate device/user bounds, the minimum delta, or the anti–short-cycling dwell timer.
- **Price frame alignment & percentile logic** – Tibber aggregation pulls today + tomorrow quarter-hour rows (typically 96 or 192 entries) and rolls them into 48 hourly buckets with an auto-detected interval plus freshness checks (`src/services/tibber-api.ts:222-309`). ENTSO-E requests always use UTC start-of-day through +48 h windows via `fetchPrices`/`retrieveEntsoeData` (`src/services/entsoe-price-service.ts:209-311`, `src/entsoe.ts:420-580`), and `TimeZoneHelper` (defaulting UTC+1 → Europe/Stockholm) propagates user offsets/DST names to providers and cron jobs (`src/util/time-zone-helper.ts:1-152`, `drivers/boiler/driver.ts:40-107`). Cheap/very-cheap tiers rely on `preheat_cheap_percentile` (default 0.25, range 0.05–0.5) and an adaptive `veryChepMultiplier` fed into `resolvePriceThresholds` (`src/services/optimizer.ts:229-244`, `src/services/price-classifier.ts:1-115`, `src/services/adaptive-parameters.ts:44-78`).
- **Baseline & savings accounting** – Even when no MELCloud command fires, the optimizer compares current holds vs. comfort/tank maxima and credits the delta via `calculateRealHourlySavings` (`src/services/optimizer.ts:2790-2889, 3030-3070`), so DHW/tank savings aren’t lost. Daily projections combine today’s optimization history with `EnhancedSavingsCalculator` and, when enabled, the `FixedBaselineCalculator` (fixed heating 21 °C, DHW 60 °C, assumed COP 2.2/1.8) to report against “dumb thermostat” behavior; serialized data lives under `optimizer_historical_data` managed by `src/orchestration/service-manager.ts:96-205` and surfaced through `api.ts`.
- **Hot-water learning & scheduling** – `HotWaterService` samples MELCloud tank telemetry every five minutes (aligned with polling), dedupes via raw energy counters, stores at most 2 016 detailed points/30 days/500 KB, and runs pattern analysis every 6 h if ≥ 12 samples exist (`src/services/hot-water/hot-water-service.ts:18-180`, `src/services/hot-water/hot-water-data-collector.ts:10-140`, `src/services/hot-water/hot-water-analyzer.ts:11-140`). Learned hourly/day-of-week patterns drive tank hold/preheat logic in the optimizer as soon as analyzer confidence crosses the configured thresholds.
- **Thermal learning guardrails** – The `ThermalDataCollector` enforces 60 day retention (min 14/max 365), 10 000 detailed points (min 2 000/max 20 000), tiered aggregation buckets, and a hard 500 KB settings cap with watchdog logging (`src/services/thermal-model/data-collector.ts:13-86`). `ThermalModelService` refreshes the model every 6 h, cleans up data every 12 h, runs the first update 30 min after boot, and exposes forced cleanup/update hooks (`src/services/thermal-model/thermal-model-service.ts:52-165`). `ThermalAnalyzer` needs ≥ 24 ordered points and blends new/old rates at 80/20 to keep confidence stable (`src/services/thermal-model/thermal-analyzer.ts:20-140`).
- **Cron ownership & timezone propagation** – Only the boiler driver owns the optimizer cron suite: hourly optimizations at `0 * * * *` and daily/“weekly” calibration at `5 0 * * *`, both created with the user’s timezone string and restarted whenever `updateTimezone()` fires (`drivers/boiler/driver.ts:34-160`). Any new scheduler must go through the driver to avoid duplicate cycles or timezone drift.

## Known Non-Issues (do NOT flag)
- **Zone 2 auto-removal** – Capability churn (Added/Removed) is expected whenever `RoomTemperatureZone2` drops below `-30 °C` or the zone name is blank; see `drivers/boiler/device.ts:214-314`. Those logs simply reflect hygiene, not device instability.
- **Energy API `MissingMinutes` noise** – `getEnergyData()` logs MELCloud’s raw `EnergyCost/Report` payload verbatim (`src/services/melcloud-api.ts:1155-1200`). The API includes a `MissingMinutes` counter that can go negative; the app never consumes that field, so negative values in logs are upstream quirks, not regressions.
- **Circuit breaker chatter under rate limits** – `CircuitBreaker` deliberately logs every OPEN/HALF-OPEN/CLOSED transition and failure count to aid rate-limit tuning (`src/util/circuit-breaker.ts:201-269`). Bursts of these entries during Tibber or MELCloud throttling are healthy backoff behavior.
- **Duplicate “Added/Removed capability” log pairs** – Device re-initialization walks the capability list on every sync and logs both add/remove operations even when nothing changes (`drivers/boiler/device.ts:214-248`). Treat those as normal startup noise.

## Optimization Focus Map
- **Optimizer decision engine** – `src/services/optimizer.ts` (all 3 k+ lines) controls price-aware setpoints, deadbands, tank/Zone 2 negotiation, adaptive learning, baseline savings, and MELCloud command issuance; any regression here affects customer comfort and savings directly.
- **Thermal learning & retention** – `src/services/thermal-model/data-collector.ts`, `thermal-model-service.ts`, and `thermal-analyzer.ts` govern memory usage, aggregation, confidence growth, and K/S calibration. Watch for retention breaches, cleanup cadence, and analyzer blending math.
- **COP tracking & adaptive parameters** – `src/services/cop-helper.ts` cron jobs plus `src/services/adaptive-parameters.ts` feed COP ranges, price weights, and seasonal aggressiveness. Issues here skew optimization focus, COP guards, and cheap-percentile boosts.
- **Price ingestion & normalization** – `src/services/tibber-api.ts`, `src/services/entsoe-price-service.ts`, `src/entsoe.ts`, `src/services/fx-rate-service.ts`, and `src/services/price-classifier.ts` handle DST, timezone offsets, currency conversion, and percentile math. Any misalignment corrupts hourly price ranks and optimizer thresholds.
- **Hot-water / tank optimization** – `src/services/hot-water/**` plus the tank branch inside `src/services/optimizer.ts` determine DHW savings, usage predictions, and legionella buffers. Validate sampling cadence, analyzer confidence, and price-aware scheduling.
- **Schedulers & circuit breakers** – `drivers/boiler/driver.ts` (cron ownership) and `src/util/circuit-breaker.ts` + `src/services/base-api-service.ts` (retry/backoff) guarantee idempotent hourly runs and API resilience. Ensure no additional schedulers or short-circuit bypasses creep in.
- **Storage & memory behavior** – `src/orchestration/service-manager.ts`, `src/app.ts`, `api.ts`, thermal/hot-water collectors, and FX/COP caches all write to Homey settings with 500 KB guardrails. Watch for oversized payloads, missing compaction, or duplicate storage keys.
- **Baseline vs smart accounting** – `src/util/enhanced-savings-calculator.ts`, `src/util/fixed-baseline-calculator.ts`, and the savings sections in `src/services/optimizer.ts` ensure savings are credited even during holds (Zone 1/2/tank). Regressions here quietly erase reported savings.

## Constants & Ranges (populate from code/logs)
- **Cheap percentile inputs** – Default `preheat_cheap_percentile = 0.25` (range 0.05–0.5) with default `veryCheapMultiplier = 0.4` in the classifier; adaptive learning starts with `veryChepMultiplier = 0.8` and clamps to [0, 1] (`src/services/optimizer.ts:215-244`, `src/services/price-classifier.ts:55-96`, `src/services/adaptive-parameters.ts:44-73`).
- **Thermal coefficients** – Optimizer seeds `ThermalModel` with `K = 0.5`, while `service-manager` initializes `initial_k = 0.3` for weekly calibration (`src/services/optimizer.ts:168-174`, `src/orchestration/service-manager.ts:31-57`). Thermal mass defaults are 2.5 kWh/°C capacity, 0.8 °C/h loss, 23 °C max preheat, 0.85 efficiency (`src/services/optimizer.ts:205-220`).
- **Adaptive price/COP weights** – Summer price weight 0.7, winter 0.4, transition 0.5; COP thresholds start at 0.8 (excellent), 0.5 (good), 0.2 (minimum) with aggressiveness knobs (`preheatAggressiveness 2 °C`, `coastingReduction 1.5 °C`, `boostIncrease 0.5 °C`) and confidence blending until ≥ 0.3 (`src/services/adaptive-parameters.ts:44-120`).
- **Comfort & setpoint bounds** – Occupied comfort 20–21 °C, away 19–20.5 °C, always clamped to 16–26 °C (`src/services/optimizer.ts:606-628`). Zone 1 step 0.5 °C, deadband 0.3 °C, dwell 30 min; Zone 2 shares the step; tank defaults 40–50 °C with 0.5 °C step but enforces `Math.max(0.5, step)` deadband before rounding (`src/services/optimizer.ts:171-237, 2515-2525`, `src/util/setpoint-constraints.ts:67-150`).
- **Tank/hold savings thresholds** – Hold-path savings kick in once current targets are ≥ 0.1 °C (zones) or ≥ 0.5 °C (tank) below their comfort/tank maxima; baseline comparisons always use comfort/tank max as the “dumb thermostat” target (`src/services/optimizer.ts:2790-2889`).
- **Thermal data guardrails** – Default retention 60 days (min 14/max 365), 10 000 max detailed points (min 2 000/max 20 000), 14 days “full-res” window, 500 KB hard cap, aggregation buckets of hour/day/2-day, and watchdog logging for memory spikes (`src/services/thermal-model/data-collector.ts:13-90`). Cleanup runs every 12 h, model updates every 6 h (`src/services/thermal-model/thermal-model-service.ts:52-118`).
- **Hot-water data guardrails** – 2 016 point cap (~7 days @ 5 min), 30 day age limit, 500 KB settings cap, minimum 12 points for pattern analysis, and 168 points for full confidence (`src/services/hot-water/hot-water-data-collector.ts:10-43`, `src/services/hot-water/hot-water-analyzer.ts:11-24`).
- **FX cache & currency overrides** – FX rates live under `fx_rate_cache` (and `fx_rate_eur_to_*`) with a 24 h TTL, pulled from frankfurter.app, and reused by ENTSO-E markup modeling (`src/services/fx-rate-service.ts:21-104`, `src/services/entsoe-price-service.ts:72-142`).
- **Timezone defaults** – UTC+1 maps to Europe/Stockholm inside `TimeZoneHelper` (`src/util/time-zone-helper.ts:13-48`), while the driver falls back to Europe/Oslo if it can’t derive a timezone string (`drivers/boiler/driver.ts:40-78`). Both the optimizer and hot-water service reinitialize timezone helpers whenever `time_zone_offset/use_dst/time_zone_name` settings change.

## Evidence Patterns in Logs
- **MELCloud session lifecycle** – Expect `“Attempting to reconnect to MELCloud…”`, `“MELCloud login successful”`, and `“MELCloud devices retrieved: N devices found”` from `src/services/melcloud-api.ts:124-440`. Failed reconnect attempts log attempt counters before raising.
- **Zone 2 sentinel traces** – Every poll prints the computed validity: `Zone 2 support check… Temperature: -39°C (valid: false)… Final result: false` from `drivers/boiler/device.ts:279-310`, confirming auto-removal behavior when the indoor sensor disappears.
- **Tibber price aggregation counts** – `src/services/tibber-api.ts:270-289` logs `Formatted price data… hourly=48, quarterHourly=96/192`, which reviewers can use to confirm both day horizons are present.
- **Structured optimizer decisions** – `documentation/HIGH_IMPACT_OPTIMIZER_REVIEW.md:44-75` captures live `constraints.tank.final`, `optimizer.setpoint.hold`, and price percentile logs, showing how deadbands, percentiles, and lockouts appear during a hold.
- **Hot-water sampling** – `[HotWater] Collected data point #… Tank 48°C→52°C… COP 2.35` plus “Need NN more data points” or “pattern analysis will start” comes from `src/services/hot-water/hot-water-service.ts:104-170`, confirming cadence and thresholds.
- **Energy API dumps & COP snapshots** – `src/services/melcloud-api.ts:1155-1210` logs `Raw energy API response:` including `Daily*Energy*` fields and `CoP` arrays, while `src/services/cop-helper.ts:98-140` logs daily/weekly/monthly COP values and snapshots saved.
- **Circuit breaker state changes** – `Circuit MELCloud OPENED…`, `HALF-OPEN`, and `CLOSED` messages plus failure counters come from `src/util/circuit-breaker.ts:201-269`; they’re expected during rate-limit windows.

## Success Criteria (reviewer must optimize for)
- **Credit savings even on holds** – Zone 1/2/tank baseline comparisons in `src/services/optimizer.ts:2790-2889` and `calculateRealHourlySavings` (`src/services/optimizer.ts:3030-3070`) must stay intact so DHW or comfort-hold savings aren’t lost when no setpoint changes occur.
- **Respect comfort & safety limits** – Any change must keep the 16–26 °C clamps, discrete steps, deadbands, tank limits, and 30 min dwell logic enforced by `getCurrentComfortBand`, `applySetpointConstraints`, and device driver settings (`src/services/optimizer.ts:171-237, 606-628`, `src/util/setpoint-constraints.ts:1-165`, `drivers/boiler/device.ts:350-390`).
- **Keep timezone/DST alignment** – Hourly runs, Tibber/ENTSO-E fetches, and hot-water sampling all rely on `TimeZoneHelper` and the driver’s cron timezone; changes must remain DST-safe (`src/util/time-zone-helper.ts:1-150`, `drivers/boiler/driver.ts:34-160`, `src/services/tibber-api.ts:51-117`, `src/entsoe.ts:420-580`).
- **Preserve storage guardrails** – Learned datasets (thermal, hot water, FX, COP, optimizer history) must respect the existing retention + 500 KB caps and continue to use the same Homey settings keys (`src/services/thermal-model/data-collector.ts:13-90`, `src/services/hot-water/hot-water-data-collector.ts:10-150`, `src/services/fx-rate-service.ts:21-104`, `src/orchestration/service-manager.ts:96-205`).
- **Avoid rate-limit regressions** – Circuit breaker protections, throttling, and cron ownership should remain untouched so API retries keep working without spamming MELCloud/Tibber (`src/services/base-api-service.ts:18-210`, `src/util/circuit-breaker.ts:98-270`, `drivers/boiler/driver.ts:34-160`).
- **DST-safe price classification** – Cheap/very-cheap logic must continue using the unified classifier and adaptive multipliers so percentile-based actions stay consistent (`src/services/optimizer.ts:215-244, 1500-1605`, `src/services/price-classifier.ts:1-115`, `src/services/adaptive-parameters.ts:44-120`).
