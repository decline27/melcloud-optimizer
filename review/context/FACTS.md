# MELCloud Optimizer — Facts & Invariants

## Domain Invariants
- **Zone 2 sentinel** – The boiler driver only keeps Zone 2 capabilities when `RoomTemperatureZone2 > -30` or a Zone 2 name exists; MELCloud reports `-39 °C` when no sensor is present, so removing the capability in that case is expected (`drivers/boiler/device.ts:268`).
- **Setpoint quantization** – Zone 1 defaults to 18–22 °C with 0.5 °C steps, a 0.3 °C deadband, and a 30 min dwell timer to prevent short cycling; Zone 2 shares the 0.5 °C step with a deadband of half the step, while tank control allows 0.5–5 °C steps and requires a delta ≥ `max(0.5 °C, step)` before commands fire (`src/services/optimizer.ts:189`, `src/services/optimizer.ts:193`, `src/services/optimizer.ts:195`, `src/services/optimizer.ts:205`, `src/services/optimizer.ts:211`, `src/services/optimizer.ts:2457`, `src/services/optimizer.ts:2574`, `src/util/setpoint-constraints.ts:58`, `src/util/setpoint-constraints.ts:143`).
- **COP sourcing & storage** – Hourly optimization ingests MELCloud enhanced COP data to set `realHeatingCOP`, `realHotWaterCOP`, efficiencies, and focus flags (`src/services/optimizer.ts:1360`), while `COPHelper` schedules daily/weekly/monthly jobs that persist produced/consumed energy plus COP snapshots under `cop_snapshots_*` for later averaging (`src/services/cop-helper.ts:4`, `src/services/cop-helper.ts:85`, `src/services/cop-helper.ts:107`, `src/services/cop-helper.ts:158`).
- **Seasonal modes** – Automatic summer/winter/transition detection keys off energy ratios: <1 kWh heating over the window → summer, heating >2× DHW → winter, else transition with trend-based focus on heating, DHW, or both (`src/services/optimizer.ts:1383`). Seasonal mode drives adaptive COP weighting, comfort adjustments, and learning targets.
- **Comfort bands & lockouts** – Occupied comfort defaults to 20–21 °C, away to 19–20.5 °C within hard 16–26 °C bounds; every proposal is clamped, rounded to the configured step, and rejected if it violates the deadband or the 30 min dwell timer before MELCloud writes (`src/services/optimizer.ts:606`, `src/services/optimizer.ts:615`, `src/services/optimizer.ts:1908`, `src/util/setpoint-constraints.ts:67`).
- **Price frame & percentile logic** – Tibber aggregates today+tomorrow QUARTER_HOURLY prices to hourly blocks with auto-detected intervals, ENTSO-E always fetches Europe/Brussels UTC start-of-day → +48 h windows, and both services honor `TimeZoneHelper` offsets plus cheap/very-cheap thresholds (defaults: 25th percentile with a 0.4 multiplier) from the unified price classifier (`src/services/tibber-api.ts:237`, `src/services/entsoe-price-service.ts:229`, `src/util/time-zone-helper.ts:18`, `src/services/price-classifier.ts:55`).
- **Baseline savings model** – `calculateRealHourlySavings` blends actual daily consumption, COP-normalized seasonal factors, and per-surface modifiers (Zone 1/Zone 2/tank) to price deltas, and the optimizer still credits savings when it simply holds below comfort/tank maxima before appending to `optimizer_historical_data` (`src/services/optimizer.ts:3028`, `src/services/optimizer.ts:2843`, `src/orchestration/service-manager.ts:136`).
- **Hot-water learning loop** – Tank telemetry is sampled every 5 min, capped at 2,016 records (~7 days) and 500 KB, with analyzer updates only after ≥12 data points and 6 h cadence; hourly and day-of-week profiles then drive tank targets and price-aware holds (`src/services/hot-water/hot-water-service.ts:19`, `src/services/hot-water/hot-water-data-collector.ts:18`, `src/services/hot-water/hot-water-analyzer.ts:15`).
- **Thermal learning guardrails** – Thermal data retention defaults to 60 days/10 k detailed points with a 500 KB settings cap, aggregated tiers, 24-point analyzer minimums, and scheduled 6 h model refresh plus 12 h cleanup to stay within Homey memory ceilings (`src/services/thermal-model/data-collector.ts:18`, `src/services/thermal-model/thermal-analyzer.ts:53`, `src/services/thermal-model/thermal-model-service.ts:55`).
- **Cron ownership** – The boiler driver runs hourly optimization (`0 * * * *`) and daily calibration at 00:05 in the user’s timezone, reinitializing those jobs when timezone settings change, so no other component should schedule conflicting crons (`drivers/boiler/driver.ts:108`).

## Known Non-Issues (do NOT flag)
- Zone 2 auto-removal whenever MELCloud reports `RoomTemperatureZone2 <= -30 °C` or the Zone 2 name is empty—this is intentional capability hygiene (`drivers/boiler/device.ts:268`).
- MELCloud energy exports occasionally emit negative `MissingMinutes` counters; treat them as upstream telemetry quirks unless a newer API contract says otherwise (per ops brief, no repo repro).
- Circuit breaker OPEN/HALF-OPEN log spam during Tibber/MELCloud rate-limit windows is normal because the breaker aggressively reports every state transition by design (`src/util/circuit-breaker.ts:34`).
- Duplicate “Added capability/Removed capability” log pairs can appear on driver re-init because the code always removes before re-adding Zone 2 capabilities (`drivers/boiler/device.ts:205`, `drivers/boiler/device.ts:232`).

## Optimization Focus Map
- **Core optimizer** – `src/services/optimizer.ts` owns comfort-band enforcement, setpoint rounding/lockouts, savings math, adaptive learning, secondary zone logic, and tank orchestration.
- **Thermal learning** – `src/services/thermal-model/data-collector.ts`, `src/services/thermal-model/thermal-analyzer.ts`, and `src/services/thermal-model/thermal-model-service.ts` cover retention, analyzer confidence, and scheduled updates/cleanup.
- **COP & adaptive parameters** – `src/services/cop-helper.ts` plus `src/services/adaptive-parameters.ts` manage COP snapshots, seasonal weighting, and business-rule blending.
- **Price ingestion** – `src/services/tibber-api.ts`, `src/services/entsoe-price-service.ts`, `src/services/price-classifier.ts`, and `src/services/fx-rate-service.ts` handle fetching, DST alignment, FX conversion, consumer markup, and percentile classification.
- **Hot-water/tank** – `src/services/hot-water/hot-water-service.ts`, `hot-water-data-collector.ts`, and `hot-water-analyzer.ts` drive tank telemetry sampling, pattern learning, and price-aware tank targets.
- **Schedulers & MELCloud integration** – `drivers/boiler/driver.ts` (cron cadence/timezone propagation) and `src/services/melcloud-api.ts` (rate limiting/circuit breaker) enforce execution order and API hygiene.
- **Circuit breaker & retries** – `src/util/circuit-breaker.ts` implements adaptive failure thresholds, exponential backoff, and timeout handling that all network services rely on.
- **Storage & memory** – `src/services/thermal-model/data-collector.ts`, `src/services/hot-water/hot-water-data-collector.ts`, and `src/orchestration/service-manager.ts` define retention windows, 500 KB safety caps, and persistence keys (`optimizer_historical_data`, `thermal_model_*`, `hot_water_usage_*`).

## Constants & Ranges
- Cheap percentile defaults to 0.25 (25th percentile) with a very-cheap multiplier of 0.4, yielding a 10th-percentile “very cheap” threshold unless adaptive learning overrides it (`src/services/optimizer.ts:218`, `src/services/price-classifier.ts:55`).
- Zone 1 defaults to 18–22 °C, Zone 2 to 18–22 °C, and tank control to 40–50 °C until user overrides; tank constraints clamp inputs to 30–70 °C with 0.5–5 °C steps (`src/services/optimizer.ts:189`, `src/services/optimizer.ts:205`, `src/services/optimizer.ts:211`, `src/services/optimizer.ts:625`).
- Deadbands: Zone 1 uses 0.3 °C, Zone 2 defaults to half the configured step (≥0.1 °C), and tank uses `max(0.5 °C, step)` (`src/services/optimizer.ts:193`, `src/services/optimizer.ts:2457`, `src/services/optimizer.ts:2574`).
- Comfort bands clamp to 20–21 °C (occupied) and 19–20.5 °C (away) but never outside 16–26 °C (`src/services/optimizer.ts:606`, `src/services/optimizer.ts:615`).
- Minimum setpoint change dwell is 30 min unless settings override it (`src/services/optimizer.ts:195`).
- Thermal model defaults: `K = 0.5`, `thermalCapacity = 2.5 kWh/°C`, `heatLossRate = 0.8 °C/h`, `thermalMass = 0.7`, and analyzer fallback rates of 0.5 °C heating / 0.2 °C cooling per degree (`src/services/optimizer.ts:189`, `src/services/optimizer.ts:228`, `src/services/thermal-model/thermal-analyzer.ts:76`).
- Hot-water defaults: hourly demand starts at 0.5 kWh with morning/evening peaks, minimum buffer 2 kWh, and analyzer confidence requires 12 data points (full confidence at 168) (`src/services/optimizer.ts:237`, `src/services/hot-water/hot-water-analyzer.ts:15`).
- Thermal collector retains 60 days/10 k points with a 500 KB cap; hot-water collector keeps ~7 days (2,016 points) and also enforces a 500 KB ceiling (`src/services/thermal-model/data-collector.ts:18`, `src/services/hot-water/hot-water-data-collector.ts:18`).
- FX rates cache for 24 h by default (`src/services/fx-rate-service.ts:22`).
- Timezone defaults map UTC+1 to `Europe/Stockholm`, and services favor IANA names when available (`src/util/time-zone-helper.ts:18`).

## Evidence Patterns in Logs
- Tank decisions during very-cheap prices are logged with constraint summaries (proposed/actual setpoints, percentiles, and hold reasons) at `documentation/HIGH_IMPACT_OPTIMIZER_REVIEW.md:42`.
- Memory watchdog output shows heap usage spikes (e.g., 20.64 MB / 22.17 MB at 93 %) and cleanup triggers during heavy learning cycles (`documentation/HIGH_IMPACT_OPTIMIZER_REVIEW.md:244`).
- Hot-water retention traces log dataset sizes (≈2,016 points, 420 KB) and cleanup actions when usage exceeds 80 % of the cap (`documentation/HIGH_IMPACT_OPTIMIZER_REVIEW.md:258`).
- Historical hourly decisions capture `action`, `targetTemp`, `priceLevel`, `pricePercentile`, savings, and hot-water deltas inside `timeSeries` entries (e.g., first record at `dashboard-output/melcloud-historical-data.json:18`).
- Simulation CSVs such as `results/v2_decisions.csv:2` include timestamped records with price, indoor/outdoor temps, setpoints, COP, and occupancy for regression testing.

## Success Criteria (reviewer must optimize for)
- **Credit savings without setpoint changes** – Holding below the comfort/tank maxima must still accumulate savings for Zone 1, Zone 2, and DHW via the baseline comparisons in `calculateRealHourlySavings` (`src/services/optimizer.ts:2843`, `src/services/optimizer.ts:2868`, `src/services/optimizer.ts:2881`).
- **Respect comfort & safety** – Comfort-band clamps, deadband enforcement, and dwell timers must stay intact (`src/services/optimizer.ts:606`, `src/services/optimizer.ts:1908`, `src/util/setpoint-constraints.ts:67`).
- **Idempotent MELCloud writes** – Lockout math and duplicate-target checks need to prevent redundant MELCloud commands while keeping `last_setpoint_change_ms` accurate for future comparisons (`src/services/optimizer.ts:195`, `src/services/optimizer.ts:2661`, `src/services/optimizer.ts:2690`).
- **DST-safe price alignment** – All price normalization, FX conversion, and cron triggers rely on consistent timezone handling via `TimeZoneHelper` plus service-specific implementations (`src/util/time-zone-helper.ts:18`, `src/services/tibber-api.ts:51`, `src/services/entsoe-price-service.ts:229`).
